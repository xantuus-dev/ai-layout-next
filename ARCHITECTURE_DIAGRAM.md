# Xantuus AI - Architecture Diagram

## ğŸ“ High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          XANTUUS AI PLATFORM                                â”‚
â”‚                     (Next.js 14 Full-Stack SaaS)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   FRONTEND  â”‚      â”‚   BACKEND   â”‚      â”‚  EXTERNAL   â”‚
         â”‚  (React 18) â”‚â—„â”€â”€â”€â”€â–ºâ”‚  (API Routes)â”‚â—„â”€â”€â”€â”€â–ºâ”‚ SERVICES    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚                     â”‚
                â”‚                     â”‚                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   Browser   â”‚      â”‚  PostgreSQL  â”‚      â”‚ Anthropic   â”‚
         â”‚   (Client)  â”‚      â”‚  + Prisma    â”‚      â”‚   OpenAI    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   Google    â”‚
                                                    â”‚   Stripe    â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Complete Application Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            APPLICATION LAYERS                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: FRONTEND UI (Client Components)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Chat Interface     â”‚  â”‚ Workflow Builder    â”‚  â”‚  Settings Pages    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ â”‚
â”‚  â”‚  â€¢ Model selection  â”‚  â”‚  â€¢ Drag-drop canvas â”‚  â”‚  â€¢ Account         â”‚ â”‚
â”‚  â”‚  â€¢ File upload      â”‚  â”‚  â€¢ Node palette     â”‚  â”‚  â€¢ Billing         â”‚ â”‚
â”‚  â”‚  â€¢ Streaming        â”‚  â”‚  â€¢ Config panel     â”‚  â”‚  â€¢ API Keys        â”‚ â”‚
â”‚  â”‚  â€¢ History          â”‚  â”‚  â€¢ Template library â”‚  â”‚  â€¢ Usage analytics â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Workspace Manager  â”‚  â”‚  Browser Control    â”‚  â”‚  Auth Components   â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â”‚
â”‚  â”‚  â€¢ Projects         â”‚  â”‚  â€¢ Navigate         â”‚  â”‚  â€¢ Sign in         â”‚ â”‚
â”‚  â”‚  â€¢ Conversations    â”‚  â”‚  â€¢ Extract          â”‚  â”‚  â€¢ OAuth buttons   â”‚ â”‚
â”‚  â”‚  â€¢ Tasks            â”‚  â”‚  â€¢ Screenshot       â”‚  â”‚  â€¢ User profile    â”‚ â”‚
â”‚  â”‚  â€¢ Templates        â”‚  â”‚  â€¢ Chat with page   â”‚  â”‚  â€¢ Session         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: API ROUTES (Backend Logic)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/chat          â”‚  â”‚  /api/workflows     â”‚  â”‚  /api/auth         â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚ â”‚
â”‚  â”‚  POST - Send msg    â”‚  â”‚  POST - Create      â”‚  â”‚  NextAuth routes   â”‚ â”‚
â”‚  â”‚  â€¢ Validate auth    â”‚  â”‚  PUT - Update       â”‚  â”‚  â€¢ Google OAuth    â”‚ â”‚
â”‚  â”‚  â€¢ Check credits    â”‚  â”‚  GET - List all     â”‚  â”‚  â€¢ Apple Sign In   â”‚ â”‚
â”‚  â”‚  â€¢ Route to AI      â”‚  â”‚  DELETE - Remove    â”‚  â”‚  â€¢ Azure AD        â”‚ â”‚
â”‚  â”‚  â€¢ Stream response  â”‚  â”‚  /execute - Run     â”‚  â”‚  â€¢ Session mgmt    â”‚ â”‚
â”‚  â”‚  â€¢ Deduct credits   â”‚  â”‚  /execution/[id]    â”‚  â”‚  â€¢ Token refresh   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/workspace     â”‚  â”‚  /api/browser       â”‚  â”‚  /api/stripe       â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚ â”‚
â”‚  â”‚  /workspaces        â”‚  â”‚  /session           â”‚  â”‚  /checkout         â”‚ â”‚
â”‚  â”‚  /conversations     â”‚  â”‚  /action            â”‚  â”‚  /portal           â”‚ â”‚
â”‚  â”‚  /tasks             â”‚  â”‚  /navigate          â”‚  â”‚  /webhook          â”‚ â”‚
â”‚  â”‚  /projects          â”‚  â”‚  /chat              â”‚  â”‚  â€¢ Subscription    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/integrations  â”‚  â”‚  /api/templates     â”‚  â”‚  /api/usage        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚ â”‚
â”‚  â”‚  /google/connect    â”‚  â”‚  GET - List         â”‚  â”‚  /credits          â”‚ â”‚
â”‚  â”‚  /google/callback   â”‚  â”‚  /[id] - Get one    â”‚  â”‚  â€¢ Get balance     â”‚ â”‚
â”‚  â”‚  /drive/list        â”‚  â”‚  /[id]/check-access â”‚  â”‚  â€¢ Get history     â”‚ â”‚
â”‚  â”‚  /gmail/send        â”‚  â”‚  /admin/templates   â”‚  â”‚  â€¢ Analytics       â”‚ â”‚
â”‚  â”‚  /calendar/create   â”‚  â”‚  â€¢ CRUD operations  â”‚  â”‚  â€¢ Reset tracking  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: BUSINESS LOGIC (Library Functions)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AI Orchestration   â”‚  â”‚  Agent System       â”‚  â”‚  Workflow Engine   â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â”‚
â”‚  â”‚  â€¢ aiRouter.ts      â”‚  â”‚  â€¢ executor.ts      â”‚  â”‚  â€¢ workflow-       â”‚ â”‚
â”‚  â”‚  â€¢ Multi-provider   â”‚  â”‚  â€¢ orchestrator.ts  â”‚  â”‚    engine.ts       â”‚ â”‚
â”‚  â”‚  â€¢ Claude/GPT/Geminiâ”‚  â”‚  â€¢ Tool registry    â”‚  â”‚  â€¢ Step execution  â”‚ â”‚
â”‚  â”‚  â€¢ Streaming        â”‚  â”‚  â€¢ ReAct loop       â”‚  â”‚  â€¢ Variable mgmt   â”‚ â”‚
â”‚  â”‚  â€¢ Token counting   â”‚  â”‚  â€¢ Task scheduling  â”‚  â”‚  â€¢ Conditionals    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Browser Control    â”‚  â”‚  Credit System      â”‚  â”‚  Google Integrationsâ”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  â€¢ browser-         â”‚  â”‚  â€¢ credits.ts       â”‚  â”‚  â€¢ google-oauth.ts â”‚ â”‚
â”‚  â”‚    control.ts       â”‚  â”‚  â€¢ hasEnoughCredits â”‚  â”‚  â€¢ google-drive.ts â”‚ â”‚
â”‚  â”‚  â€¢ Puppeteer        â”‚  â”‚  â€¢ deductCredits    â”‚  â”‚  â€¢ google-gmail.ts â”‚ â”‚
â”‚  â”‚  â€¢ Stealth mode     â”‚  â”‚  â€¢ calculateCost    â”‚  â”‚  â€¢ google-         â”‚ â”‚
â”‚  â”‚  â€¢ Security sandbox â”‚  â”‚  â€¢ resetCredits     â”‚  â”‚    calendar.ts     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Billing & Payments â”‚  â”‚  Template System    â”‚  â”‚  Auth & Security   â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â”‚
â”‚  â”‚  â€¢ stripe.ts        â”‚  â”‚  â€¢ agent-plan-to-   â”‚  â”‚  â€¢ auth.ts         â”‚ â”‚
â”‚  â”‚  â€¢ revenuecat-      â”‚  â”‚    visual-converter â”‚  â”‚  â€¢ api-auth.ts     â”‚ â”‚
â”‚  â”‚    server.ts        â”‚  â”‚  â€¢ workflow-        â”‚  â”‚  â€¢ rate-limit.ts   â”‚ â”‚
â”‚  â”‚  â€¢ Subscription mgmtâ”‚  â”‚    converter.ts     â”‚  â”‚  â€¢ Session mgmt    â”‚ â”‚
â”‚  â”‚  â€¢ Webhook handlers â”‚  â”‚  â€¢ Templates libraryâ”‚  â”‚  â€¢ API key auth    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 4: DATA LAYER (Database & ORM)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PRISMA ORM (prisma/schema.prisma)                                  â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  [User] â”€â”€â”€â”€â”€â”€â”                                                     â”‚   â”‚
â”‚  â”‚    â€¢ Auth      â”‚                                                    â”‚   â”‚
â”‚  â”‚    â€¢ Credits   â”œâ”€â”€â”€â”€â–º [Account] (OAuth providers)                  â”‚   â”‚
â”‚  â”‚    â€¢ Plan      â”‚                                                    â”‚   â”‚
â”‚  â”‚    â€¢ Tokens    â”œâ”€â”€â”€â”€â–º [Session] (Active sessions)                  â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [UsageRecord] (Credit tracking)              â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [Workspace] â”€â”€â–º [Project]                    â”‚   â”‚
â”‚  â”‚                â”‚                   â””â–º [Conversation] â”€â”€â–º [Message] â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [Task] â”€â”€â–º [TaskExecution]                   â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [Workflow] â”€â”€â–º [WorkflowExecution]           â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [BrowserSession] â”€â”€â–º [WebpageContext]        â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [PageMonitor] â”€â”€â–º [MonitorAlert]             â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [ApiKey]                                      â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â”œâ”€â”€â”€â”€â–º [Integration]                                 â”‚   â”‚
â”‚  â”‚                â”‚                                                    â”‚   â”‚
â”‚  â”‚                â””â”€â”€â”€â”€â–º [CustomTool]                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  [PromptTemplate] â”€â”€â–º [PromptTemplateCategory]                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  [WebhookEvent] (Idempotency for Stripe/RevenueCat)                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PostgreSQL Database (Supabase)                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚  â€¢ Connection pooling                                               â”‚   â”‚
â”‚  â”‚  â€¢ Automatic backups                                                â”‚   â”‚
â”‚  â”‚  â€¢ Real-time subscriptions (future)                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 5: EXTERNAL SERVICES                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AI Providers       â”‚  â”‚  Authentication     â”‚  â”‚  Billing & Paymentsâ”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚  â€¢ Anthropic Claude â”‚  â”‚  â€¢ Google OAuth     â”‚  â”‚  â€¢ Stripe (Web)    â”‚ â”‚
â”‚  â”‚  â€¢ OpenAI GPT       â”‚  â”‚  â€¢ Apple Sign In    â”‚  â”‚  â€¢ RevenueCat      â”‚ â”‚
â”‚  â”‚  â€¢ Google Gemini    â”‚  â”‚  â€¢ Azure AD         â”‚  â”‚    (Mobile)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Google Services    â”‚  â”‚  Browser Automation â”‚  â”‚  Monitoring        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â”‚
â”‚  â”‚  â€¢ Google Drive     â”‚  â”‚  â€¢ Puppeteer        â”‚  â”‚  â€¢ Cloudflare      â”‚ â”‚
â”‚  â”‚  â€¢ Gmail API        â”‚  â”‚  â€¢ Chrome/Chromium  â”‚  â”‚    Turnstile       â”‚ â”‚
â”‚  â”‚  â€¢ Calendar API     â”‚  â”‚  â€¢ Browser extensionâ”‚  â”‚  â€¢ Sentry (future) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Diagrams

### 1. Chat Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Send message
     â”‚    + files (optional)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatInterface.tsx  â”‚ (React Component)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. POST /api/chat
     â”‚    { content, model, files }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/chat/route.ts                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  1. Authenticate (getServerSession)                          â”‚
â”‚  2. Check rate limit (5/min)                                 â”‚
â”‚  3. Validate & get user from DB                              â”‚
â”‚  4. Check credits (hasEnoughCredits)                         â”‚
â”‚  5. Process file uploads (if any)                            â”‚
â”‚  6. Route to AI provider (aiRouter.chat)                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Call AI provider
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  aiRouter.ts (Multi-provider orchestrator)                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Route to: Claude / GPT / Gemini based on model selection  â”‚
â”‚  â€¢ Handle streaming                                          â”‚
â”‚  â€¢ Count tokens                                              â”‚
â”‚  â€¢ Return response chunks                                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. Stream response
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Anthropic/OpenAI/Google API                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Process prompt                                            â”‚
â”‚  â€¢ Generate response                                         â”‚
â”‚  â€¢ Stream tokens                                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Response chunks
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/chat/route.ts (continued)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. Count final tokens                                       â”‚
â”‚  2. Calculate credits used                                   â”‚
â”‚  3. Deduct credits (deductCredits)                           â”‚
â”‚     â””â”€â–º Create UsageRecord                                   â”‚
â”‚     â””â”€â–º Update User.creditsUsed                              â”‚
â”‚  4. Save conversation (if applicable)                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Stream to client
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚ â† Response displayed in real-time
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Visual Workflow Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Build workflow visually
     â”‚    â€¢ Drag nodes
     â”‚    â€¢ Configure
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowBuilderCanvas.tsx                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ WorkflowCanvas (drop zone)                                â”‚
â”‚  â€¢ WorkflowNodePalette (step types)                          â”‚
â”‚  â€¢ WorkflowNodeConfigPanel (settings)                        â”‚
â”‚  â€¢ WorkflowTemplateLibrary (pre-built)                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Click "Test Run"
     â”‚    POST /api/workflows/execute
     â”‚    { nodes: CanvasNode[], name, description }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/workflows/execute/route.ts                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. Authenticate                                             â”‚
â”‚  2. Validate workflow (validateWorkflow)                     â”‚
â”‚  3. Convert visual â†’ agent plan                              â”‚
â”‚     (convertVisualWorkflowToAgentPlan)                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Visual nodes â†’ Execution plan
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  visual-to-agent-converter.ts                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Maps node types to tool calls                             â”‚
â”‚  â€¢ navigate â†’ browser.navigate                               â”‚
â”‚  â€¢ click â†’ browser.click                                     â”‚
â”‚  â€¢ type â†’ browser.type                                       â”‚
â”‚  â€¢ extract â†’ browser.extract                                 â”‚
â”‚  â€¢ Creates ExecutionPlan with steps                          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. ExecutionPlan ready
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/workflows/execute/route.ts (continued)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. Check credits (estimatedCredits)                         â”‚
â”‚  2. Create Task in database                                  â”‚
â”‚  3. Execute in background via AgentExecutor                  â”‚
â”‚  4. Return executionId                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Execute plan
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AgentExecutor (ReAct Loop)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  For each step in ExecutionPlan:                             â”‚
â”‚    1. REASON: Analyze step requirements                      â”‚
â”‚    2. ACT: Execute tool (browser/email/calendar/AI)          â”‚
â”‚    3. OBSERVE: Process tool result                           â”‚
â”‚    4. Save TaskExecution record                              â”‚
â”‚  Loop until all steps complete or error                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Tool execution
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Registry                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ browser.navigate â†’ Puppeteer navigate                     â”‚
â”‚  â€¢ browser.click â†’ Puppeteer click                           â”‚
â”‚  â€¢ browser.extract â†’ Puppeteer extract + AI                  â”‚
â”‚  â€¢ email.send â†’ Gmail API                                    â”‚
â”‚  â€¢ calendar.create â†’ Calendar API                            â”‚
â”‚  â€¢ ai.chat â†’ Claude/GPT                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 7. Execution updates
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/workflows/execution/[id]/route.ts                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Frontend polls every 1 second                             â”‚
â”‚  â€¢ Returns current execution state                           â”‚
â”‚  â€¢ Maps steps to visual nodes                                â”‚
â”‚  â€¢ Returns: pending/running/completed/failed                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. Real-time updates
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowBuilderStore (Zustand)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ updateExecutionStates(nodeStates)                         â”‚
â”‚  â€¢ Updates each node's executionState                        â”‚
â”‚  â€¢ Triggers re-render                                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 9. Visual feedback
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowNode.tsx                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Gray (pending)                                            â”‚
â”‚  â€¢ Blue + pulse (running)                                    â”‚
â”‚  â€¢ Green (completed)                                         â”‚
â”‚  â€¢ Red (failed)                                              â”‚
â”‚  â€¢ Shows output/error below node                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 10. User sees execution
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚ â† Watches nodes turn blue â†’ green
â”‚ Browser â”‚   Real-time execution feedback
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Subscription & Billing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Visit /pricing
     â”‚    Click "Subscribe to Pro"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/stripe/checkout/route.ts                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. Get user from session                                    â”‚
â”‚  2. Create Stripe Checkout Session                           â”‚
â”‚     â€¢ priceId (pro/enterprise)                               â”‚
â”‚     â€¢ customer email                                         â”‚
â”‚     â€¢ success/cancel URLs                                    â”‚
â”‚  3. Return checkout URL                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Redirect to Stripe
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripe Hosted Checkout                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Collect payment details                                   â”‚
â”‚  â€¢ Process payment                                           â”‚
â”‚  â€¢ Create subscription                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Payment success
     â”‚    Webhook: checkout.session.completed
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/stripe/webhook/route.ts                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. Verify webhook signature (HMAC-SHA256)                   â”‚
â”‚  2. Check WebhookEvent for idempotency                       â”‚
â”‚  3. Parse event type                                         â”‚
â”‚  4. Handle checkout.session.completed:                       â”‚
â”‚     â€¢ Retrieve subscription details                          â”‚
â”‚     â€¢ Update User:                                           â”‚
â”‚       - plan = 'pro'                                         â”‚
â”‚       - monthlyCredits = 12000                               â”‚
â”‚       - stripeSubscriptionId = sub_xxx                       â”‚
â”‚       - stripeCurrentPeriodEnd = ...                         â”‚
â”‚  5. Create WebhookEvent record                               â”‚
â”‚  6. Return 200 OK                                            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. Subscription active
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database Updated                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  User {                                                      â”‚
â”‚    plan: "pro",                                              â”‚
â”‚    monthlyCredits: 12000,                                    â”‚
â”‚    stripeSubscriptionId: "sub_xxx",                          â”‚
â”‚    stripeCustomerId: "cus_xxx"                               â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. Session refresh
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚ â† Sees "Pro" badge
â”‚ Browser â”‚   12,000 credits available
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. Template-Based Workflow Creation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â”‚ Browser â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. Click "Browse Templates"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowTemplateLibrary.tsx                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Display template cards                                    â”‚
â”‚  â€¢ Show: name, description, tags, cost, duration             â”‚
â”‚  â€¢ getWorkflowTemplates() - Client-side data                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. Click "Competitor Price Monitor"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configuration Dialog                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ User fills in:                                            â”‚
â”‚    - Competitor URL                                          â”‚
â”‚    - Price CSS Selector                                      â”‚
â”‚    - Alert Threshold                                         â”‚
â”‚    - Alert Email                                             â”‚
â”‚  â€¢ Validation (required, email format, URL format)           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. Click "Use Template"
     â”‚    { competitorUrl, priceSelector, threshold, email }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-plan-to-visual-converter.ts                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  convertPriceMonitorToVisualNodes(config)                    â”‚
â”‚  Creates 3 CanvasNodes:                                      â”‚
â”‚    1. Navigate â†’ config.competitorUrl                        â”‚
â”‚    2. Wait â†’ config.priceSelector                            â”‚
â”‚    3. Extract â†’ config.priceSelector                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. CanvasNode[]
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowBuilderStore (Zustand)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ setNodes(canvasNodes)                                     â”‚
â”‚  â€¢ setWorkflowName("Competitor Price Monitor")               â”‚
â”‚  â€¢ setWorkflowDescription(...)                               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. State updated
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WorkflowCanvas.tsx                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Re-renders with 3 nodes                                   â”‚
â”‚  â€¢ Connection lines appear                                   â”‚
â”‚  â€¢ Step numbers: 1, 2, 3                                     â”‚
â”‚  â€¢ Each node shows configuration preview                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. Visual feedback
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚ â† Sees pre-configured workflow instantly
â”‚ Browser â”‚   Ready to save/execute
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Component Hierarchy (Frontend)

```
App (Root)
â”‚
â”œâ”€â”€â”€ SessionProvider (NextAuth context)
â”‚    â”‚
â”‚    â””â”€â”€â”€ RootLayout (/app/layout.tsx)
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Navigation
â”‚         â”‚    â”œâ”€â”€â”€ Logo
â”‚         â”‚    â”œâ”€â”€â”€ Nav Links
â”‚         â”‚    â””â”€â”€â”€ UserProfileDropdown
â”‚         â”‚         â”œâ”€â”€â”€ Credits Display
â”‚         â”‚         â”œâ”€â”€â”€ Settings Link
â”‚         â”‚         â””â”€â”€â”€ Sign Out
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Home Page (/)
â”‚         â”‚    â”œâ”€â”€â”€ HeroSection
â”‚         â”‚    â”œâ”€â”€â”€ ChatInterface
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ ClaudeStyleChatInput
â”‚         â”‚    â”‚    â”‚    â”œâ”€â”€â”€ Textarea (autosize)
â”‚         â”‚    â”‚    â”‚    â”œâ”€â”€â”€ FileUploadButton
â”‚         â”‚    â”‚    â”‚    â””â”€â”€â”€ SendButton
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ MessageList
â”‚         â”‚    â”‚    â”‚    â””â”€â”€â”€ Message (user/assistant)
â”‚         â”‚    â”‚    â”‚         â”œâ”€â”€â”€ Markdown renderer
â”‚         â”‚    â”‚    â”‚         â””â”€â”€â”€ CodeBlock (syntax highlight)
â”‚         â”‚    â”‚    â””â”€â”€â”€ ModelSelector
â”‚         â”‚    â”‚         â””â”€â”€â”€ Select (Claude/GPT/Gemini)
â”‚         â”‚    â””â”€â”€â”€ TemplateCarousel
â”‚         â”‚         â””â”€â”€â”€ TemplateCard (featured)
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Workflows (/workflows)
â”‚         â”‚    â”‚
â”‚         â”‚    â”œâ”€â”€â”€ Builder (/workflows/builder) â­ NEW
â”‚         â”‚    â”‚    â””â”€â”€â”€ WorkflowBuilderCanvas
â”‚         â”‚    â”‚         â”œâ”€â”€â”€ WorkflowCanvasToolbar
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ WorkflowMetadataInputs
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ CreditEstimate (Popover)
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ ZoomControls
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ SaveButton (Dialog)
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ TestRunButton
â”‚         â”‚    â”‚         â”‚    â””â”€â”€â”€ UseTemplateButton â­ NEW
â”‚         â”‚    â”‚         â”‚
â”‚         â”‚    â”‚         â”œâ”€â”€â”€ DndContext (@dnd-kit)
â”‚         â”‚    â”‚         â”‚    â”‚
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ WorkflowNodePalette (Left)
â”‚         â”‚    â”‚         â”‚    â”‚    â””â”€â”€â”€ NodeTypeCard
â”‚         â”‚    â”‚         â”‚    â”‚         â”œâ”€â”€â”€ Icon
â”‚         â”‚    â”‚         â”‚    â”‚         â”œâ”€â”€â”€ Label
â”‚         â”‚    â”‚         â”‚    â”‚         â”œâ”€â”€â”€ Description
â”‚         â”‚    â”‚         â”‚    â”‚         â””â”€â”€â”€ onClick â†’ addNode()
â”‚         â”‚    â”‚         â”‚    â”‚
â”‚         â”‚    â”‚         â”‚    â”œâ”€â”€â”€ WorkflowCanvas (Center)
â”‚         â”‚    â”‚         â”‚    â”‚    â”œâ”€â”€â”€ EmptyState
â”‚         â”‚    â”‚         â”‚    â”‚    â”‚    â”œâ”€â”€â”€ "Add First Step"
â”‚         â”‚    â”‚         â”‚    â”‚    â”‚    â””â”€â”€â”€ "Browse Templates" â­ NEW
â”‚         â”‚    â”‚         â”‚    â”‚    â”œâ”€â”€â”€ ConnectionLines (SVG)
â”‚         â”‚    â”‚         â”‚    â”‚    â”‚    â””â”€â”€â”€ Bezier paths
â”‚         â”‚    â”‚         â”‚    â”‚    â””â”€â”€â”€ SortableContext
â”‚         â”‚    â”‚         â”‚    â”‚         â””â”€â”€â”€ WorkflowNode (sortable)
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ DragHandle
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ NodeIcon
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ NodeLabel
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ ConfigPreview
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ ExecutionStateBadge
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ ErrorHandlingBadge
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ OutputBadge
â”‚         â”‚    â”‚         â”‚    â”‚              â”œâ”€â”€â”€ ExecutionOutput
â”‚         â”‚    â”‚         â”‚    â”‚              â””â”€â”€â”€ RemoveButton
â”‚         â”‚    â”‚         â”‚    â”‚
â”‚         â”‚    â”‚         â”‚    â””â”€â”€â”€ WorkflowNodeConfigPanel (Right)
â”‚         â”‚    â”‚         â”‚         â”œâ”€â”€â”€ NodeTypeDisplay
â”‚         â”‚    â”‚         â”‚         â”œâ”€â”€â”€ DynamicConfigForm
â”‚         â”‚    â”‚         â”‚         â”‚    â””â”€â”€â”€ Type-specific fields
â”‚         â”‚    â”‚         â”‚         â”œâ”€â”€â”€ ErrorHandlingSection
â”‚         â”‚    â”‚         â”‚         â”‚    â”œâ”€â”€â”€ OnError strategy
â”‚         â”‚    â”‚         â”‚         â”‚    â”œâ”€â”€â”€ Max retries
â”‚         â”‚    â”‚         â”‚         â”‚    â””â”€â”€â”€ Retry delay
â”‚         â”‚    â”‚         â”‚         â””â”€â”€â”€ OutputSection
â”‚         â”‚    â”‚         â”‚              â”œâ”€â”€â”€ Save output toggle
â”‚         â”‚    â”‚         â”‚              â””â”€â”€â”€ Variable name input
â”‚         â”‚    â”‚         â”‚
â”‚         â”‚    â”‚         â””â”€â”€â”€ WorkflowTemplateLibrary â­ NEW
â”‚         â”‚    â”‚              â”œâ”€â”€â”€ TemplateGridDialog
â”‚         â”‚    â”‚              â”‚    â””â”€â”€â”€ TemplateCard
â”‚         â”‚    â”‚              â”‚         â”œâ”€â”€â”€ Icon + Name
â”‚         â”‚    â”‚              â”‚         â”œâ”€â”€â”€ Description
â”‚         â”‚    â”‚              â”‚         â”œâ”€â”€â”€ Tags (badges)
â”‚         â”‚    â”‚              â”‚         â”œâ”€â”€â”€ Credits estimate
â”‚         â”‚    â”‚              â”‚         â”œâ”€â”€â”€ Duration estimate
â”‚         â”‚    â”‚              â”‚         â””â”€â”€â”€ Difficulty badge
â”‚         â”‚    â”‚              â”‚
â”‚         â”‚    â”‚              â””â”€â”€â”€ ConfigurationDialog
â”‚         â”‚    â”‚                   â”œâ”€â”€â”€ Dynamic form fields
â”‚         â”‚    â”‚                   â”œâ”€â”€â”€ Validation errors
â”‚         â”‚    â”‚                   â”œâ”€â”€â”€ "What this will do" preview
â”‚         â”‚    â”‚                   â””â”€â”€â”€ UseTemplateButton
â”‚         â”‚    â”‚
â”‚         â”‚    â””â”€â”€â”€ Price Monitor (/workflows/price-monitor)
â”‚         â”‚         â”œâ”€â”€â”€ ConfigurationForm
â”‚         â”‚         â””â”€â”€â”€ MonitorList
â”‚         â”‚              â””â”€â”€â”€ MonitorCard
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Workspace (/workspace)
â”‚         â”‚    â”œâ”€â”€â”€ Projects
â”‚         â”‚    â”œâ”€â”€â”€ Conversations
â”‚         â”‚    â”œâ”€â”€â”€ Tasks
â”‚         â”‚    â””â”€â”€â”€ Templates
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Browser (/browser)
â”‚         â”‚    â”œâ”€â”€â”€ BrowserControlPanel
â”‚         â”‚    â”œâ”€â”€â”€ BrowserChatInterface
â”‚         â”‚    â””â”€â”€â”€ PageContextViewer
â”‚         â”‚
â”‚         â”œâ”€â”€â”€ Settings (/settings)
â”‚         â”‚    â”œâ”€â”€â”€ Account (/settings/account)
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ PersonalizationForm
â”‚         â”‚    â”‚    â””â”€â”€â”€ DangerZone
â”‚         â”‚    â”‚
â”‚         â”‚    â”œâ”€â”€â”€ Billing (/settings/billing)
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ CurrentPlanCard
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ UpgradeButton
â”‚         â”‚    â”‚    â””â”€â”€â”€ CustomerPortalLink
â”‚         â”‚    â”‚
â”‚         â”‚    â”œâ”€â”€â”€ Usage (/settings/usage)
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ CreditBalance
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ UsageChart (Recharts)
â”‚         â”‚    â”‚    â””â”€â”€â”€ UsageTable
â”‚         â”‚    â”‚
â”‚         â”‚    â”œâ”€â”€â”€ API Keys (/settings/api-keys)
â”‚         â”‚    â”‚    â”œâ”€â”€â”€ CreateKeyButton
â”‚         â”‚    â”‚    â””â”€â”€â”€ ApiKeyList
â”‚         â”‚    â”‚         â””â”€â”€â”€ ApiKeyCard
â”‚         â”‚    â”‚
â”‚         â”‚    â””â”€â”€â”€ Integrations (/settings/integrations)
â”‚         â”‚         â”œâ”€â”€â”€ GoogleIntegrationCard
â”‚         â”‚         â”‚    â”œâ”€â”€â”€ Drive toggle
â”‚         â”‚         â”‚    â”œâ”€â”€â”€ Gmail toggle
â”‚         â”‚         â”‚    â””â”€â”€â”€ Calendar toggle
â”‚         â”‚         â””â”€â”€â”€ ConnectButton
â”‚         â”‚
â”‚         â””â”€â”€â”€ Pricing (/pricing)
â”‚              â””â”€â”€â”€ PricingCards
â”‚                   â””â”€â”€â”€ PricingCard (Free/Pro/Enterprise)
â”‚                        â”œâ”€â”€â”€ Price
â”‚                        â”œâ”€â”€â”€ Features list
â”‚                        â””â”€â”€â”€ SubscribeButton
```

---

## ğŸ§© Agent System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AUTONOMOUS AGENT SYSTEM                             â”‚
â”‚                           (ReAct Loop Pattern)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  AgentOrchestratorâ”‚
                              â”‚  (orchestrator.ts)â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
             â”‚  Poll Tasks  â”‚    â”‚  Worker    â”‚    â”‚  Statistics â”‚
             â”‚  (60s cron)  â”‚    â”‚   Pool     â”‚    â”‚   Tracking  â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚ (max 10)   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  AgentExecutor  â”‚
                    â”‚  (executor.ts)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   PLANNING  â”‚    â”‚     â”‚  EXECUTION  â”‚
         â”‚   (Once)    â”‚    â”‚     â”‚   (Loop)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚            â”‚            â”‚
                â”‚            â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              REACT LOOP (Reason â†’ Act â†’ Observe)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. REASON PHASE                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ Analyze current step                   â”‚         â”‚
â”‚     â”‚ â€¢ What needs to be done?                â”‚         â”‚
â”‚     â”‚ â€¢ What tools are available?             â”‚         â”‚
â”‚     â”‚ â€¢ What's the context?                   â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                     â”‚                                   â”‚
â”‚  2. ACT PHASE       â–¼                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ Execute tool call                      â”‚         â”‚
â”‚     â”‚ â€¢ Select tool from registry            â”‚         â”‚
â”‚     â”‚ â€¢ Prepare parameters                   â”‚         â”‚
â”‚     â”‚ â€¢ Execute with timeout                 â”‚         â”‚
â”‚     â”‚ â€¢ Handle errors                        â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                     â”‚                                   â”‚
â”‚  3. OBSERVE PHASE   â–¼                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ Process tool result                    â”‚         â”‚
â”‚     â”‚ â€¢ Parse output                         â”‚         â”‚
â”‚     â”‚ â€¢ Save to variables                    â”‚         â”‚
â”‚     â”‚ â€¢ Update execution trace               â”‚         â”‚
â”‚     â”‚ â€¢ Check if goal achieved               â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                     â”‚                                   â”‚
â”‚                     â””â”€â”€â”€â”€â”€â–º Loop until complete         â”‚
â”‚                            or max steps reached         â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚Tool Registry â”‚    â”‚     â”‚  Database   â”‚
         â”‚  (20+ tools) â”‚    â”‚     â”‚   Updates   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚            â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚Browserâ”‚  â”‚ Email â”‚  â”‚ Calendarâ”‚  â”‚  AI   â”‚
â”‚ Tools â”‚  â”‚ Tools â”‚  â”‚  Tools  â”‚  â”‚ Tools â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚           â”‚            â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
â”‚ â€¢ navigate    â€¢ send        â€¢ create       â”‚
â”‚ â€¢ click       â€¢ read        â€¢ list         â”‚
â”‚ â€¢ type                      â€¢ update       â”‚
â”‚ â€¢ extract     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â€¢ screenshot  â”‚ Google   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â€¢ waitFor     â”‚   APIs   â”‚  â”‚ Claude/  â”‚  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   GPT    â”‚  â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Entity Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATABASE SCHEMA (Prisma)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚ (Central entity)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚ PK
â”‚ email       â”‚ Unique
â”‚ name        â”‚
â”‚ plan        â”‚ (free/pro/enterprise)
â”‚ credits     â”‚ monthlyCredits, creditsUsed, creditsResetAt
â”‚ stripe      â”‚ customerId, subscriptionId, priceId
â”‚ google      â”‚ accessToken, refreshToken, tokenExpiry
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                                          â”‚
       â”‚ 1:N                                                      â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Account   â”‚ (OAuth providers)                          â”‚  Session   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id         â”‚ PK                                         â”‚ id         â”‚ PK
   â”‚ userId     â”‚ FK â†’ User                                  â”‚ userId     â”‚ FK
   â”‚ provider   â”‚ (google/apple/azure)                       â”‚ token      â”‚
   â”‚ providerAccountId                                       â”‚ expires    â”‚
   â”‚ access_token                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ refresh_token
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  UsageRecord   â”‚ (Credit tracking)
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id             â”‚ PK
   â”‚ userId         â”‚ FK â†’ User
   â”‚ type           â”‚ (chat/api/automation)
   â”‚ model          â”‚ (claude-sonnet/gpt-4/etc)
   â”‚ tokens         â”‚ Input + output
   â”‚ credits        â”‚ Amount deducted
   â”‚ metadata       â”‚ JSON
   â”‚ createdAt      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Workspace    â”‚ (Organization)
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id             â”‚ PK
   â”‚ userId         â”‚ FK â†’ User
   â”‚ name           â”‚
   â”‚ description    â”‚
   â”‚ isDefault      â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Project    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id           â”‚ PK
    â”‚ workspaceId  â”‚ FK â†’ Workspace
    â”‚ name         â”‚
    â”‚ description  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”‚ 1:N
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Conversation    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id               â”‚ PK
    â”‚ workspaceId      â”‚ FK â†’ Workspace
    â”‚ title            â”‚
    â”‚ isPinned         â”‚
    â”‚ isArchived       â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Message   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ id          â”‚ PK
     â”‚ conversationId â”‚ FK â†’ Conversation
     â”‚ role        â”‚ (user/assistant/system)
     â”‚ content     â”‚ Text
     â”‚ model       â”‚
     â”‚ tokens      â”‚
     â”‚ credits     â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ MessageAttachment     â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ id                    â”‚ PK
       â”‚ messageId             â”‚ FK â†’ Message
       â”‚ fileName              â”‚
       â”‚ fileType              â”‚
       â”‚ fileUrl               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     Task       â”‚ (Agent tasks)
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id             â”‚ PK
   â”‚ userId         â”‚ FK â†’ User
   â”‚ workspaceId    â”‚ FK â†’ Workspace (optional)
   â”‚ title          â”‚
   â”‚ agentType      â”‚ (browser/email/data/research)
   â”‚ status         â”‚ (pending/planning/executing/completed/failed)
   â”‚ plan           â”‚ JSON (ExecutionPlan)
   â”‚ totalSteps     â”‚
   â”‚ currentStep    â”‚
   â”‚ result         â”‚ JSON
   â”‚ executionTrace â”‚ JSON
   â”‚ schedule       â”‚ Cron expression
   â”‚ totalCredits   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TaskExecution    â”‚ (Execution steps)
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id               â”‚ PK
    â”‚ taskId           â”‚ FK â†’ Task
    â”‚ step             â”‚ Step number
    â”‚ action           â”‚ Tool name
    â”‚ input            â”‚ JSON
    â”‚ output           â”‚ JSON
    â”‚ status           â”‚ (running/completed/failed)
    â”‚ credits          â”‚
    â”‚ duration         â”‚ ms
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Workflow     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id             â”‚ PK
   â”‚ userId         â”‚ FK â†’ User
   â”‚ name           â”‚
   â”‚ description    â”‚
   â”‚ steps          â”‚ JSON (WorkflowStep[])
   â”‚ schedule       â”‚ Cron
   â”‚ isActive       â”‚
   â”‚ totalRuns      â”‚
   â”‚ successfulRuns â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WorkflowExecution    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id                   â”‚ PK
    â”‚ workflowId           â”‚ FK â†’ Workflow
    â”‚ status               â”‚ (running/completed/failed)
    â”‚ currentStep          â”‚
    â”‚ result               â”‚ JSON
    â”‚ executionTrace       â”‚ JSON
    â”‚ totalCredits         â”‚
    â”‚ duration             â”‚ ms
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  BrowserSession     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id                  â”‚ PK
   â”‚ userId              â”‚ FK â†’ User
   â”‚ url                 â”‚
   â”‚ title               â”‚
   â”‚ cookies             â”‚ JSON
   â”‚ status              â”‚ (active/paused/closed)
   â”‚ chatEnabled         â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  WebpageContext     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ id                  â”‚ PK
     â”‚ sessionId           â”‚ FK â†’ BrowserSession
     â”‚ url                 â”‚
     â”‚ mainContent         â”‚ Text
     â”‚ structuredData      â”‚ JSON
     â”‚ contentSummary      â”‚ AI-generated
     â”‚ embeddings          â”‚ Vector (future)
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  PageMonitor     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id               â”‚ PK
   â”‚ userId           â”‚ FK â†’ User
   â”‚ name             â”‚
   â”‚ url              â”‚
   â”‚ checkType        â”‚ (text/element/screenshot/ai)
   â”‚ checkInterval    â”‚ Minutes
   â”‚ selector         â”‚ CSS selector
   â”‚ alertChannels    â”‚ (email/slack/webhook)
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MonitorAlert   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id             â”‚ PK
    â”‚ monitorId      â”‚ FK â†’ PageMonitor
    â”‚ changeType     â”‚ (content_changed/element_appeared)
    â”‚ oldValue       â”‚
    â”‚ newValue       â”‚
    â”‚ delivered      â”‚ Boolean
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   ApiKey        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id              â”‚ PK
   â”‚ userId          â”‚ FK â†’ User
   â”‚ name            â”‚
   â”‚ keyHash         â”‚ SHA-256
   â”‚ lastUsedAt      â”‚
   â”‚ createdAt       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Integration       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id                  â”‚ PK
   â”‚ userId              â”‚ FK â†’ User
   â”‚ provider            â”‚ (notion/slack/zapier)
   â”‚ accessToken         â”‚
   â”‚ refreshToken        â”‚
   â”‚ isActive            â”‚
   â”‚ config              â”‚ JSON
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚ 1:N (from User)
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   CustomTool        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ id                  â”‚ PK
   â”‚ userId              â”‚ FK â†’ User
   â”‚ name                â”‚
   â”‚ endpoint            â”‚ URL
   â”‚ method              â”‚ (GET/POST)
   â”‚ parameters          â”‚ JSON Schema
   â”‚ authentication      â”‚ JSON
   â”‚ totalCalls          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptTemplate     â”‚ (Global or user-specific)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚ PK
â”‚ userId              â”‚ FK â†’ User (nullable for global)
â”‚ categoryId          â”‚ FK â†’ PromptTemplateCategory
â”‚ title               â”‚
â”‚ template            â”‚ Text with {{variables}}
â”‚ variables           â”‚ JSON
â”‚ tier                â”‚ (free/pro/enterprise)
â”‚ isPublic            â”‚
â”‚ usageCount          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptTemplateCategory     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                          â”‚ PK
â”‚ name                        â”‚
â”‚ icon                        â”‚
â”‚ order                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebhookEvent       â”‚ (Idempotency)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                  â”‚ PK
â”‚ provider            â”‚ (stripe/revenuecat)
â”‚ eventId             â”‚ Unique (from provider)
â”‚ eventType           â”‚
â”‚ processed           â”‚ Boolean
â”‚ createdAt           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Key Library Functions

```
src/lib/
â”œâ”€â”€ auth.ts
â”‚   â””â”€â”€ authOptions (NextAuth configuration)
â”‚
â”œâ”€â”€ prisma.ts
â”‚   â””â”€â”€ prisma (Singleton client)
â”‚
â”œâ”€â”€ credits.ts
â”‚   â”œâ”€â”€ hasEnoughCredits(userId, amount)
â”‚   â”œâ”€â”€ deductCredits(userId, amount, metadata)
â”‚   â”œâ”€â”€ calculateCreditCost(model, tokens)
â”‚   â””â”€â”€ checkAndResetCredits(user)
â”‚
â”œâ”€â”€ aiRouter.ts
â”‚   â”œâ”€â”€ chat(model, messages, stream)
â”‚   â”œâ”€â”€ routeToProvider(model)
â”‚   â””â”€â”€ countTokens(text)
â”‚
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ executor.ts
â”‚   â”‚   â”œâ”€â”€ executeTask(taskId, plan)
â”‚   â”‚   â”œâ”€â”€ reasonPhase(context)
â”‚   â”‚   â”œâ”€â”€ actPhase(action, params)
â”‚   â”‚   â””â”€â”€ observePhase(result)
â”‚   â”‚
â”‚   â”œâ”€â”€ orchestrator.ts
â”‚   â”‚   â”œâ”€â”€ pollTasks() (cron: every 60s)
â”‚   â”‚   â”œâ”€â”€ workerPool (max 10 concurrent)
â”‚   â”‚   â””â”€â”€ trackStatistics()
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ index.ts (Tool registry)
â”‚   â”‚   â”œâ”€â”€ browser.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ navigate(url)
â”‚   â”‚   â”‚   â”œâ”€â”€ click(selector)
â”‚   â”‚   â”‚   â”œâ”€â”€ type(selector, text)
â”‚   â”‚   â”‚   â”œâ”€â”€ extract(selector)
â”‚   â”‚   â”‚   â”œâ”€â”€ screenshot()
â”‚   â”‚   â”‚   â””â”€â”€ waitFor(selector, timeout)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ email.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ send(to, subject, body)
â”‚   â”‚   â”‚   â””â”€â”€ read(query)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ calendar.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ create(event)
â”‚   â”‚   â”‚   â””â”€â”€ list(timeMin, timeMax)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ drive.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ upload(file)
â”‚   â”‚   â”‚   â””â”€â”€ list(query)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ai.ts
â”‚   â”‚       â”œâ”€â”€ chat(prompt)
â”‚   â”‚       â””â”€â”€ extract(text, schema)
â”‚   â”‚
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ competitor-price-monitor.ts
â”‚           â”œâ”€â”€ createPriceMonitorPlan()
â”‚           â”œâ”€â”€ createPriceMonitorTask()
â”‚           â””â”€â”€ validatePriceMonitorConfig()
â”‚
â”œâ”€â”€ workflow-engine.ts
â”‚   â”œâ”€â”€ executeWorkflow(workflowId)
â”‚   â”œâ”€â”€ executeStep(step, variables)
â”‚   â”œâ”€â”€ evaluateCondition(condition, variables)
â”‚   â””â”€â”€ handleStepError(step, error)
â”‚
â”œâ”€â”€ workflow-builder/
â”‚   â”œâ”€â”€ workflow-converter.ts
â”‚   â”‚   â”œâ”€â”€ convertToWorkflowSteps(nodes)
â”‚   â”‚   â”œâ”€â”€ convertFromWorkflowSteps(steps)
â”‚   â”‚   â””â”€â”€ validateWorkflow(nodes, name)
â”‚   â”‚
â”‚   â”œâ”€â”€ visual-to-agent-converter.ts
â”‚   â”‚   â”œâ”€â”€ convertVisualWorkflowToAgentPlan()
â”‚   â”‚   â”œâ”€â”€ convertNodeToExecutionStep()
â”‚   â”‚   â””â”€â”€ estimateWorkflowCredits()
â”‚   â”‚
â”‚   â””â”€â”€ agent-plan-to-visual-converter.ts â­ NEW
â”‚       â”œâ”€â”€ convertAgentPlanToVisualNodes()
â”‚       â”œâ”€â”€ convertPriceMonitorToVisualNodes()
â”‚       â”œâ”€â”€ getWorkflowTemplates()
â”‚       â””â”€â”€ getTemplateById(id)
â”‚
â”œâ”€â”€ browser-control.ts
â”‚   â”œâ”€â”€ createBrowserSession()
â”‚   â”œâ”€â”€ navigate(url)
â”‚   â”œâ”€â”€ extractContent()
â”‚   â”œâ”€â”€ screenshot()
â”‚   â””â”€â”€ securityValidation()
â”‚
â”œâ”€â”€ browser-chat.ts
â”‚   â”œâ”€â”€ chatWithPage(url, question)
â”‚   â”œâ”€â”€ extractMainContent()
â”‚   â””â”€â”€ generatePageSummary()
â”‚
â”œâ”€â”€ google-oauth.ts
â”‚   â”œâ”€â”€ oauthClient (Google OAuth2)
â”‚   â”œâ”€â”€ refreshAccessToken(user)
â”‚   â””â”€â”€ getAuthUrl(scopes)
â”‚
â”œâ”€â”€ google-drive.ts
â”‚   â”œâ”€â”€ listFiles(user, query)
â”‚   â””â”€â”€ uploadFile(user, file)
â”‚
â”œâ”€â”€ google-gmail.ts
â”‚   â”œâ”€â”€ sendEmail(user, to, subject, body)
â”‚   â””â”€â”€ listMessages(user, query)
â”‚
â”œâ”€â”€ google-calendar.ts
â”‚   â”œâ”€â”€ listEvents(user, timeMin, timeMax)
â”‚   â””â”€â”€ createEvent(user, event)
â”‚
â”œâ”€â”€ stripe.ts
â”‚   â”œâ”€â”€ stripe (Stripe client)
â”‚   â”œâ”€â”€ createCheckoutSession(userId, priceId)
â”‚   â”œâ”€â”€ createPortalSession(customerId)
â”‚   â””â”€â”€ handleWebhook(event)
â”‚
â”œâ”€â”€ revenuecat-server.ts
â”‚   â”œâ”€â”€ getCustomer(userId)
â”‚   â”œâ”€â”€ grantEntitlements(userId, productId)
â”‚   â””â”€â”€ handleWebhook(event)
â”‚
â”œâ”€â”€ rate-limit.ts
â”‚   â”œâ”€â”€ checkRateLimit(identifier, limit, window)
â”‚   â””â”€â”€ rateLimitStore (in-memory)
â”‚
â””â”€â”€ api-auth.ts
    â”œâ”€â”€ validateApiKey(keyHash)
    â””â”€â”€ authenticateRequest(req)
```

---

## ğŸ¨ State Management (Zustand)

```
src/stores/
â”‚
â””â”€â”€ workflow-builder-store.ts â­ (470+ lines)
    â”‚
    â”œâ”€â”€ Interface: CanvasNode
    â”‚   â”œâ”€â”€ id: string
    â”‚   â”œâ”€â”€ type: 'navigate' | 'click' | 'type' | 'extract' | 'wait' | 'conditional'
    â”‚   â”œâ”€â”€ position: { x, y }
    â”‚   â”œâ”€â”€ config:
    â”‚   â”‚   â”œâ”€â”€ action: any (type-specific)
    â”‚   â”‚   â”œâ”€â”€ onError: 'stop' | 'continue' | 'retry' | 'ai_recovery'
    â”‚   â”‚   â”œâ”€â”€ maxRetries: number
    â”‚   â”‚   â”œâ”€â”€ retryDelay: number
    â”‚   â”‚   â”œâ”€â”€ condition?: { variable, operator, value }
    â”‚   â”‚   â”œâ”€â”€ skipIfFalse: boolean
    â”‚   â”‚   â”œâ”€â”€ saveOutput: boolean
    â”‚   â”‚   â””â”€â”€ outputName?: string
    â”‚   â””â”€â”€ executionState?: 'pending' | 'running' | 'completed' | 'failed' | 'skipped'
    â”‚
    â””â”€â”€ Store State & Actions:
        â”‚
        â”œâ”€â”€ nodes: CanvasNode[]
        â”œâ”€â”€ selectedNodeId: string | null
        â”œâ”€â”€ workflowId: string | null
        â”œâ”€â”€ workflowName: string
        â”œâ”€â”€ workflowDescription: string
        â”‚
        â”œâ”€â”€ zoom: number (0.5 - 2.0)
        â”œâ”€â”€ panX: number
        â”œâ”€â”€ panY: number
        â”‚
        â”œâ”€â”€ isPalettePanelOpen: boolean
        â”œâ”€â”€ isConfigPanelOpen: boolean
        â”‚
        â”œâ”€â”€ isExecuting: boolean
        â”œâ”€â”€ currentExecutionId: string | null
        â”‚
        â”œâ”€â”€ Actions:
        â”‚   â”œâ”€â”€ addNode(type)
        â”‚   â”œâ”€â”€ removeNode(id)
        â”‚   â”œâ”€â”€ updateNode(id, updates)
        â”‚   â”œâ”€â”€ reorderNodes(fromIndex, toIndex)
        â”‚   â”œâ”€â”€ selectNode(id)
        â”‚   â”œâ”€â”€ updateNodeConfig(id, config)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ setNodes(nodes) â­ NEW (for templates)
        â”‚   â”œâ”€â”€ setWorkflowName(name) â­ NEW
        â”‚   â”œâ”€â”€ setWorkflowDescription(desc) â­ NEW
        â”‚   â”‚
        â”‚   â”œâ”€â”€ setZoom(zoom)
        â”‚   â”œâ”€â”€ setPan(x, y)
        â”‚   â”œâ”€â”€ resetView()
        â”‚   â”‚
        â”‚   â”œâ”€â”€ clearWorkflow()
        â”‚   â”œâ”€â”€ loadWorkflow(data)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ startExecution(executionId)
        â”‚   â”œâ”€â”€ updateExecutionStates(nodeStates)
        â”‚   â””â”€â”€ stopExecution()
        â”‚
        â””â”€â”€ Computed Values (selectors):
            â”œâ”€â”€ useSelectedNode() â†’ CanvasNode | null
            â””â”€â”€ useIsWorkflowValid() â†’ boolean
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SECURITY LAYERS                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LAYER 1: Authentication & Authorization
â”œâ”€â”€ NextAuth.js Session Management
â”‚   â”œâ”€â”€ Secure HTTP-only cookies
â”‚   â”œâ”€â”€ Session expiry (30 days)
â”‚   â”œâ”€â”€ CSRF protection
â”‚   â””â”€â”€ Token refresh (OAuth providers)
â”‚
â”œâ”€â”€ API Key Authentication (Alternative)
â”‚   â”œâ”€â”€ SHA-256 hashed keys
â”‚   â”œâ”€â”€ Rate limiting per key
â”‚   â””â”€â”€ Last used tracking
â”‚
â””â”€â”€ Role-based Access (Future)
    â”œâ”€â”€ User roles (free/pro/enterprise/admin)
    â””â”€â”€ Resource permissions

LAYER 2: API Security
â”œâ”€â”€ Rate Limiting
â”‚   â”œâ”€â”€ 5 requests/minute (chat)
â”‚   â”œâ”€â”€ Configurable per endpoint
â”‚   â””â”€â”€ In-memory store
â”‚
â”œâ”€â”€ Input Validation
â”‚   â”œâ”€â”€ Zod/TypeScript validation
â”‚   â”œâ”€â”€ SQL injection prevention (Prisma ORM)
â”‚   â”œâ”€â”€ XSS prevention (sanitize inputs)
â”‚   â””â”€â”€ File upload size limits
â”‚
â””â”€â”€ CORS Configuration
    â”œâ”€â”€ Allowed origins whitelist
    â””â”€â”€ Credential handling

LAYER 3: Browser Control Security
â”œâ”€â”€ Sandbox Environment
â”‚   â”œâ”€â”€ Separate Puppeteer instance per user
â”‚   â”œâ”€â”€ Resource limits (5 pages, 2min timeout)
â”‚   â””â”€â”€ Memory constraints
â”‚
â”œâ”€â”€ Content Filtering
â”‚   â”œâ”€â”€ Prompt injection detection
â”‚   â”‚   â””â”€â”€ Patterns: "ignore previous", "jailbreak", etc.
â”‚   â”œâ”€â”€ XSS pattern detection
â”‚   â”‚   â””â”€â”€ Patterns: <script>, onclick=, eval()
â”‚   â””â”€â”€ Response size limits (10MB max)
â”‚
â”œâ”€â”€ Domain Blocking
â”‚   â”œâ”€â”€ localhost, 127.0.0.1
â”‚   â”œâ”€â”€ AWS metadata: 169.254.169.254
â”‚   â””â”€â”€ GCP metadata: metadata.google.internal
â”‚
â””â”€â”€ URL Validation
    â”œâ”€â”€ Allow: http://, https://
    â””â”€â”€ Block: file://, ftp://, etc.

LAYER 4: Data Security
â”œâ”€â”€ Encryption at Rest
â”‚   â”œâ”€â”€ Database: Supabase encryption
â”‚   â”œâ”€â”€ Access tokens: Encrypted fields
â”‚   â””â”€â”€ API keys: Hashed (SHA-256)
â”‚
â”œâ”€â”€ Encryption in Transit
â”‚   â”œâ”€â”€ HTTPS only (production)
â”‚   â””â”€â”€ TLS 1.2+ required
â”‚
â””â”€â”€ Sensitive Data Handling
    â”œâ”€â”€ No passwords stored (OAuth only)
    â”œâ”€â”€ Tokens refreshed automatically
    â””â”€â”€ PII minimization

LAYER 5: Webhook Security
â”œâ”€â”€ Stripe Webhooks
â”‚   â”œâ”€â”€ Signature verification (HMAC-SHA256)
â”‚   â”œâ”€â”€ Idempotency check (WebhookEvent table)
â”‚   â””â”€â”€ Event replay protection
â”‚
â””â”€â”€ RevenueCat Webhooks
    â”œâ”€â”€ Custom signature header verification
    â””â”€â”€ Idempotency check

LAYER 6: Credit System Security
â”œâ”€â”€ Server-side Validation
â”‚   â”œâ”€â”€ Check balance before execution
â”‚   â”œâ”€â”€ Atomic deduction (database transaction)
â”‚   â””â”€â”€ Audit trail (UsageRecord)
â”‚
â””â”€â”€ Fraud Prevention
    â”œâ”€â”€ Rate limiting
    â”œâ”€â”€ Suspicious activity monitoring (future)
    â””â”€â”€ Usage anomaly detection (future)

LAYER 7: Environment Security
â”œâ”€â”€ Environment Variables
â”‚   â”œâ”€â”€ .env.local (never committed)
â”‚   â”œâ”€â”€ Production secrets in Vercel
â”‚   â””â”€â”€ Separate dev/prod keys
â”‚
â””â”€â”€ Dependency Security
    â”œâ”€â”€ npm audit (regular)
    â”œâ”€â”€ Dependabot alerts
    â””â”€â”€ Minimal dependency tree
```

---

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PRODUCTION DEPLOYMENT                                â”‚
â”‚                          (Vercel + Supabase)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Vercel Edge Network            â”‚
â”‚  (Global CDN + Serverless Functions)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Static Assets (/_next/static)   â”‚ â”‚
â”‚  â”‚  â€¢ JS bundles                    â”‚ â”‚
â”‚  â”‚  â€¢ CSS files                     â”‚ â”‚
â”‚  â”‚  â€¢ Images                        â”‚ â”‚
â”‚  â”‚  â€¢ Cached at edge                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Server Components               â”‚ â”‚
â”‚  â”‚  â€¢ Pre-rendered pages            â”‚ â”‚
â”‚  â”‚  â€¢ Incremental regeneration      â”‚ â”‚
â”‚  â”‚  â€¢ Edge functions                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  API Routes (Serverless)         â”‚ â”‚
â”‚  â”‚  â€¢ /api/chat                     â”‚ â”‚
â”‚  â”‚  â€¢ /api/workflows/*              â”‚ â”‚
â”‚  â”‚  â€¢ /api/auth/*                   â”‚ â”‚
â”‚  â”‚  â€¢ Cold start: ~300ms            â”‚ â”‚
â”‚  â”‚  â€¢ Warm: ~50ms                   â”‚ â”‚
â”‚  â”‚  â€¢ Timeout: 10s (Hobby)          â”‚ â”‚
â”‚  â”‚            60s (Pro)             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Database connections
             â”‚ (Connection pooling)
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Supabase PostgreSQL              â”‚
â”‚    (Managed Database + Auth + Storage) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Connection Pooler               â”‚ â”‚
â”‚  â”‚  â€¢ Handles serverless connectionsâ”‚ â”‚
â”‚  â”‚  â€¢ Pool size: 1000               â”‚ â”‚
â”‚  â”‚  â€¢ Transaction mode              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PostgreSQL Database             â”‚ â”‚
â”‚  â”‚  â€¢ Automatic backups (daily)     â”‚ â”‚
â”‚  â”‚  â€¢ Point-in-time recovery        â”‚ â”‚
â”‚  â”‚  â€¢ Replication (HA)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Supabase Storage (Future)       â”‚ â”‚
â”‚  â”‚  â€¢ File uploads                  â”‚ â”‚
â”‚  â”‚  â€¢ Screenshots                   â”‚ â”‚
â”‚  â”‚  â€¢ Attachments                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

External Services (APIs):
â”œâ”€â”€ Anthropic Claude (AI)
â”œâ”€â”€ OpenAI GPT (AI)
â”œâ”€â”€ Google Gemini (AI)
â”œâ”€â”€ Google APIs (OAuth, Drive, Gmail, Calendar)
â”œâ”€â”€ Stripe (Payments)
â”œâ”€â”€ RevenueCat (Mobile billing)
â””â”€â”€ Cloudflare Turnstile (Bot protection)
```

---

## ğŸ“Š Component File Structure

```
/Users/darchie/platform/ai-layout/ai-layout-next/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                          (Next.js 14 App Router)
â”‚   â”‚   â”œâ”€â”€ layout.tsx                (Root layout)
â”‚   â”‚   â”œâ”€â”€ page.tsx                  (Home page with ChatInterface)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                      (Backend API routes)
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/[...nextauth]/   (NextAuth routes)
â”‚   â”‚   â”‚   â”œâ”€â”€ chat/                 (AI chat endpoint)
â”‚   â”‚   â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts          (CRUD)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ execute/          (Execute workflow)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ execution/[id]/   (Get status)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ price-monitor/    (Price monitor API)
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ workspaces/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ conversations/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ projects/
â”‚   â”‚   â”‚   â”œâ”€â”€ browser/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ action/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ integrations/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ google/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ connect/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ callback/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ drive/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ gmail/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ calendar/
â”‚   â”‚   â”‚   â”œâ”€â”€ stripe/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ checkout/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ portal/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ webhook/
â”‚   â”‚   â”‚   â”œâ”€â”€ templates/            (Prompt templates)
â”‚   â”‚   â”‚   â””â”€â”€ usage/                (Credit usage)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â”‚   â”œâ”€â”€ builder/              â­ Visual workflow builder
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ price-monitor/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ workspace/
â”‚   â”‚   â”œâ”€â”€ browser/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â”œâ”€â”€ account/
â”‚   â”‚   â”‚   â”œâ”€â”€ billing/
â”‚   â”‚   â”‚   â”œâ”€â”€ usage/
â”‚   â”‚   â”‚   â”œâ”€â”€ api-keys/
â”‚   â”‚   â”‚   â””â”€â”€ integrations/
â”‚   â”‚   â””â”€â”€ pricing/
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                       (shadcn/ui components)
â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ tooltip.tsx â­ NEW
â”‚   â”‚   â”‚   â””â”€â”€ popover.tsx â­ NEW
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ workflow-builder/ â­ NEW (Phase 1 & 2)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowCanvas.tsx              (Drop zone + empty state)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowNode.tsx                (Draggable node)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowNodePalette.tsx         (Step type library)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowNodeConfigPanel.tsx     (Configuration form)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowCanvasToolbar.tsx       (Controls + save/run)
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowBuilderCanvas.tsx       (Main orchestrator)
â”‚   â”‚   â”‚   â”œâ”€â”€ ConnectionLines.tsx             (SVG Bezier curves)
â”‚   â”‚   â”‚   â””â”€â”€ WorkflowTemplateLibrary.tsx â­  (Template browser + config)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ChatInterface.tsx
â”‚   â”‚   â”œâ”€â”€ UserProfileDropdown.tsx
â”‚   â”‚   â””â”€â”€ ThemeToggle.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”œâ”€â”€ prisma.ts
â”‚   â”‚   â”œâ”€â”€ credits.ts
â”‚   â”‚   â”œâ”€â”€ aiRouter.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”‚   â”œâ”€â”€ executor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ orchestrator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â””â”€â”€ workflows/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ workflow-engine.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ workflow-builder/ â­ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ workflow-converter.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ visual-to-agent-converter.ts
â”‚   â”‚   â”‚   â””â”€â”€ agent-plan-to-visual-converter.ts â­ (Phase 2)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ browser-control.ts
â”‚   â”‚   â”œâ”€â”€ browser-chat.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ google-oauth.ts
â”‚   â”‚   â”œâ”€â”€ google-drive.ts
â”‚   â”‚   â”œâ”€â”€ google-gmail.ts
â”‚   â”‚   â””â”€â”€ google-calendar.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ workflow-builder-store.ts â­ (Zustand state management)
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ next-auth.d.ts
â”‚
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma              (Database schema - 20+ models)
â”‚
â”œâ”€â”€ browser-extension/             (Chrome extension)
â”‚   â”œâ”€â”€ manifest.json
â”‚   â”œâ”€â”€ background.js
â”‚   â”œâ”€â”€ popup.js
â”‚   â””â”€â”€ popup.html
â”‚
â”œâ”€â”€ public/
â”‚   â””â”€â”€ assets/
â”‚
â”œâ”€â”€ .env.local                     (Environment variables)
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ next.config.js
â”œâ”€â”€ CLAUDE.md                      (Development guide)
â”œâ”€â”€ ARCHITECTURE_DIAGRAM.md â­ NEW (This file)
â””â”€â”€ VISUAL_WORKFLOW_AI_INTEGRATION.md â­ (Phase 1 docs)
```

---

## ğŸ”¥ Critical Paths (Request â†’ Response)

### Path 1: Chat Message (300-2000ms)
```
User types â†’ ChatInterface.tsx â†’ POST /api/chat â†’ Authenticate (50ms) â†’
Check credits (20ms) â†’ Route to Claude API (500-1500ms) â†’ Stream response â†’
Deduct credits (30ms) â†’ Display in UI
```

### Path 2: Visual Workflow Execution (5-60s)
```
User clicks "Test Run" â†’ Validate workflow (10ms) â†’ Convert visual to plan (50ms) â†’
Check credits (20ms) â†’ Create Task (30ms) â†’ AgentExecutor.execute() â†’
For each step: browser.navigate/click/extract (1-5s each) â†’
Update execution state (10ms) â†’ Poll status (1s intervals) â†’
Update UI with node colors
```

### Path 3: Template to Workflow (< 100ms)
```
User clicks "Use Template" â†’ Fill config form â†’ Click apply â†’
convertPriceMonitorToVisualNodes() (10ms) â†’ setNodes() Zustand (5ms) â†’
Canvas re-renders (20ms) â†’ 3 nodes appear instantly
```

### Path 4: Subscription (5-10s)
```
User clicks "Subscribe" â†’ POST /api/stripe/checkout (100ms) â†’
Create session (500ms) â†’ Redirect to Stripe (200ms) â†’
User completes payment (5-10s) â†’ Webhook received (50ms) â†’
Update database (100ms) â†’ Session refreshes (50ms) â†’ UI updates
```

---

## ğŸ¯ Key Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SYSTEM INTEGRATION MAP                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Visual Workflow Builder â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Agent Executor
     (User creates)                                  (Backend runs)
          â”‚                                               â”‚
          â”‚ 1. CanvasNode[]                              â”‚
          â”‚                                               â”‚
          â”œâ”€â”€â”€â”€â”€â”€â–º visual-to-agent-converter.ts          â”‚
          â”‚         â€¢ Maps node types â†’ tool calls       â”‚
          â”‚         â€¢ Creates ExecutionPlan              â”‚
          â”‚                                               â”‚
          â”‚                                               â”‚
          â”‚                                               â–¼
          â”‚                                     AgentExecutor.execute()
          â”‚                                               â”‚
          â”‚                                               â”‚
          â”‚ 4. Real-time updates                          â”‚ 3. Execute tools
          â”‚    (polling every 1s)                         â”‚    (browser/email/AI)
          â”‚                                               â”‚
          â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    2. ExecutionPlan
                       (step-by-step)


Database (Prisma) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º All API Routes
   (Single source                            (Read/write)
    of truth)
        â”‚
        â”œâ”€â”€â–º User table â”€â”€â–º Authentication, Credits, Subscriptions
        â”‚
        â”œâ”€â”€â–º Task table â”€â”€â–º Agent execution tracking
        â”‚
        â”œâ”€â”€â–º Workflow table â”€â”€â–º Saved workflow definitions
        â”‚
        â”œâ”€â”€â–º UsageRecord table â”€â”€â–º Credit deductions, analytics
        â”‚
        â””â”€â”€â–º Session table â”€â”€â–º Active user sessions


External APIs â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Library Functions
(Anthropic, Google, Stripe)                 (Orchestrators)
        â”‚
        â”œâ”€â”€â–º aiRouter.ts â”€â”€â–º Multi-provider AI routing
        â”‚
        â”œâ”€â”€â–º google-*.ts â”€â”€â–º OAuth, Drive, Gmail, Calendar
        â”‚
        â””â”€â”€â–º stripe.ts â”€â”€â–º Checkout, webhooks, portal


Browser Extension â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Backend API
(Chrome, client-side)                   (/api/browser/session/cookies)
        â”‚
        â”‚ 1. Auto-sync cookies every 60s
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â–º POST /api/browser/session/cookies
        â”‚         â€¢ Stores cookies in database
        â”‚         â€¢ Associated with user session
        â”‚
        â””â”€â”€â”€â”€â”€â”€â–º Browser automation uses cookies
                  â€¢ Authenticated scraping
                  â€¢ Session continuity
```

---

## ğŸ“ˆ Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERFORMANCE METRICS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Component                  | Initial Load | Re-render | Memory Usage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ChatInterface              | 150ms        | 10-20ms   | 5-10 MB
WorkflowBuilderCanvas      | 200ms        | 15-30ms   | 10-20 MB (20 nodes)
WorkflowTemplateLibrary    | 50ms         | 5ms       | 2 MB
Settings pages             | 100ms        | 5-10ms    | 3-5 MB

API Endpoint              | Cold Start | Warm      | Database Query
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/api/chat                 | 300ms      | 50ms      | 20-50ms (user lookup)
/api/workflows/execute    | 400ms      | 80ms      | 30-80ms (task create)
/api/stripe/webhook       | 250ms      | 40ms      | 50-100ms (update user)
/api/templates            | 200ms      | 30ms      | 10-30ms (list query)

Agent Operations          | Duration   | Credits   | Retries
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
browser.navigate          | 2-5s       | 10        | Up to 2
browser.click             | 500ms-2s   | 5         | Up to 2
browser.extract           | 1-3s       | 10        | Up to 2
email.send                | 1-2s       | 10        | Up to 3
ai.chat (Haiku)           | 500ms-1s   | 50        | N/A
ai.chat (Sonnet)          | 1-3s       | 100       | N/A

Database Operations       | Query Time | Connection Pool
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User lookup (by email)    | 5-15ms     | Pooled (Supabase)
Create UsageRecord        | 10-20ms    | Transaction
Update User credits       | 10-20ms    | Transaction
Task execution save       | 20-50ms    | Transaction
Workflow execution list   | 15-30ms    | Indexed query
```

---

This architecture document provides a complete visual reference for the Xantuus AI platform. All components, flows, and integrations are mapped out for easy understanding and navigation.

**Key Highlights:**
âœ… 20+ API endpoints
âœ… 20+ database models
âœ… 20+ agent tools
âœ… 6 workflow builder components
âœ… Multi-provider AI routing
âœ… Complete security layers
âœ… Real-time execution monitoring
âœ… Template system architecture

**File Location:** `/Users/darchie/platform/ai-layout/ai-layout-next/ARCHITECTURE_DIAGRAM.md`
