// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // Subscription & Billing
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // RevenueCat Integration
  revenueCatUserId     String? @unique
  revenueCatCustomerId String? // Original transaction app user ID

  // Plan & Limits
  plan           String   @default("free") // free, pro, enterprise
  monthlyCredits Int      @default(1000)
  creditsUsed    Int      @default(0)
  creditsResetAt DateTime @default(now())
  billingCycle   String? // monthly, yearly

  // Payment Status
  paymentFailed   Boolean   @default(false)
  paymentFailedAt DateTime?

  // Google Integrations
  googleAccessToken     String?   @db.Text
  googleRefreshToken    String?   @db.Text
  googleTokenExpiry     DateTime?
  googleDriveEnabled    Boolean   @default(false)
  googleGmailEnabled    Boolean   @default(false)
  googleCalendarEnabled Boolean   @default(false)

  // Usage tracking
  usageRecords UsageRecord[]
  apiKeys      ApiKey[]

  // Workspace features
  workspaces    Workspace[]
  conversations Conversation[]
  projects      Project[]
  tasks         Task[]

  // AI Browser features
  browserSessions BrowserSession[]
  workflows       Workflow[]
  monitors        PageMonitor[]
  integrations    Integration[]

  // Referral system
  referralCode     String?    @unique // User's own referral code
  referredBy       String? // Referral code of user who referred them
  referredUsers    Referral[] @relation("Referrer")
  referralReceived Referral?  @relation("Referred")

  // Personalization fields
  nickname          String? // User's preferred nickname (50 char limit)
  occupation        String? // User's occupation/role (100 char limit)
  bio               String? @db.Text // User's bio/about (2000 char limit)
  customInstructions String? @db.Text // Custom instructions for AI (3000 char limit)

  // Memory system relations
  memoryMeta           UserMemoryMeta?
  memoryFiles          MemoryFile[]
  memorySearchLogs     MemorySearchLog[]
  indexingConfig       UserIndexingConfig?
  indexedSessions      IndexedSession[]
  memoryFacts          MemoryFact[]
  consolidationJobs    ConsolidationJob[]
  messageImportance    MessageImportance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Subscription & Usage Models
model UsageRecord {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    String // "chat", "api", "automation", etc.
  model   String? // AI model used
  tokens  Int     @default(0)
  credits Int     @default(1) // Credits consumed

  metadata Json? // Additional data

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  key      String    @unique
  lastUsed DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Webhook Event Tracking (for idempotency)
model WebhookEvent {
  id        String  @id @default(cuid())
  provider  String // 'stripe' or 'revenuecat'
  eventId   String  @unique // The event ID from the provider
  eventType String // Event type (e.g., 'customer.subscription.updated')
  processed Boolean @default(true)
  payload   Json? // Optional: store the full payload for debugging

  createdAt DateTime @default(now())

  @@index([provider, eventId])
  @@index([createdAt])
}

// Prompt Template System
model PromptTemplateCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String? // Icon name or emoji
  order       Int     @default(0)

  templates PromptTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromptTemplate {
  id String @id @default(cuid())

  // Template Info
  title       String
  description String?
  template    String  @db.Text // The prompt with {{variable}} placeholders

  // Organization
  categoryId String?
  category   PromptTemplateCategory? @relation(fields: [categoryId], references: [id])
  tags       String[] // For additional filtering

  // Variables Configuration
  // JSON structure: [{ name: "variable_name", label: "Display Label", type: "text|number|select", placeholder: "...", options: [] }]
  variables Json @default("[]")

  // Visibility & Status
  isPublic   Boolean @default(true)
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Analytics
  usageCount Int @default(0)

  // Premium/Tier System
  tier String @default("free") // 'free', 'pro', 'enterprise'

  // Integration Requirements
  requiresGoogleDrive Boolean @default(false)
  requiresGmail       Boolean @default(false)
  requiresCalendar    Boolean @default(false)
  supportsImageGen    Boolean @default(false)

  // Admin tracking
  createdBy String? // Admin user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isPublic, isActive])
  @@index([tier, isActive])
}

// Workspace Models
model Project {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  name        String
  description String? @db.Text
  color       String? // Hex color for project identification
  icon        String? // Icon identifier

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt])
  @@index([workspaceId])
}

model Task {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  title       String
  description String? @db.Text
  status      String  @default("pending") // pending, planning, executing, paused, completed, failed, cancelled
  priority    String  @default("medium") // low, medium, high, urgent

  // Agent/AI Configuration
  agentType   String? // "browser_automation", "email_campaign", "data_processing", "research"
  agentModel  String? // Which AI model/agent to use for this task
  agentConfig Json? // Agent-specific configuration

  // Execution plan
  plan         Json?   // Execution plan from planner
  planTokens   Int     @default(0) // Tokens used for planning
  planCredits  Int     @default(0) // Credits used for planning

  // Execution tracking
  currentStep    Int       @default(0) // Which step is currently executing
  totalSteps     Int       @default(0) // Total steps in plan
  attempts       Int       @default(0)
  lastRunAt      DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  failedAt       DateTime?

  // Results and state
  result         Json?     // Final result
  executionTrace Json?     // Full trace of what agent did
  error          String?   @db.Text // Error message if failed

  // Resource usage
  totalTokens    Int       @default(0)
  totalCredits   Int       @default(0)
  executionTime  Int       @default(0) // Milliseconds

  // Scheduling configuration
  schedule        String?   // Cron expression: "0 9 * * *" for daily 9 AM
  scheduleEnabled Boolean   @default(false) // Is scheduling active?
  nextRunAt       DateTime? // Next scheduled execution time
  timezone        String?   @default("America/New_York") // User's timezone for cron

  // Task metadata
  dueDate     DateTime?
  tags        String[]

  // Relations
  executions  TaskExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, priority]) // For queue polling
  @@index([scheduleEnabled, nextRunAt]) // For orchestrator scheduling
}

// Referral System
model Referral {
  id String @id @default(cuid())

  referrerId String
  referrer   User   @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  referredId String @unique
  referred   User   @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  creditsAwarded Int    @default(500) // Credits given to both parties
  status         String @default("pending") // pending, completed

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([referrerId])
  @@index([referredId])
}

// Workspace System Models

// Workspace - Groups projects and conversations per user
model Workspace {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text
  icon        String? // Icon identifier or emoji
  color       String? // Hex color for workspace identification
  isDefault   Boolean @default(false) // One default workspace per user

  // Relations
  projects      Project[]
  conversations Conversation[]
  members       WorkspaceMember[]

  // Organization
  order Int @default(0) // For custom ordering in sidebar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
  @@index([userId, order])
}

// Conversation - Persistent chat threads
model Conversation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  title   String  @default("Untitled Conversation") // Auto-generated from first message or user-defined
  summary String? @db.Text // AI-generated summary of conversation

  // Organization
  isPinned   Boolean  @default(false)
  isFavorite Boolean  @default(false)
  isArchived Boolean  @default(false)
  tags       String[] // User-defined tags for organization
  folder     String? // Folder path for hierarchical organization

  // Metadata
  model         String? // Primary AI model used
  messageCount  Int      @default(0)
  lastMessageAt DateTime @default(now())

  // Relations
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([userId, lastMessageAt])
  @@index([userId, isArchived])
  @@index([userId, folder])
}

// Message - Individual chat messages
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // "user" | "assistant" | "system"
  content String @db.Text

  // AI metadata
  model           String? // AI model used for this response
  tokens          Int? // Token count for this message
  credits         Int? // Credits consumed for this message
  thinkingEnabled Boolean @default(false)

  // Attachments
  attachments MessageAttachment[]

  // Message metadata
  isEdited        Boolean   @default(false)
  editedAt        DateTime?
  parentMessageId String? // For future threading support

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId, createdAt])
  @@index([conversationId])
}

// MessageAttachment - File uploads with messages
model MessageAttachment {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  fileName String
  fileType String // MIME type
  fileSize Int // In bytes
  fileUrl  String? @db.Text // S3/storage URL if applicable
  fileData String? @db.Text // Base64 encoded data for small files

  // Image-specific metadata
  width     Int?
  height    Int?
  thumbnail String? @db.Text // Thumbnail for images

  createdAt DateTime @default(now())

  @@index([messageId])
}

// WorkspaceMember - For future collaboration features
model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId      String // Member user ID
  role        String @default("member") // "owner" | "admin" | "member" | "viewer"
  permissions Json? // Granular permissions

  invitedBy String? // User ID who sent invite
  invitedAt DateTime  @default(now())
  joinedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

// Agent Execution System
// Detailed execution log for each step of an agent's execution
model TaskExecution {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  step        Int    // Which step this execution represents
  action      String // What action was taken (e.g., "browser.navigate")
  tool        String? // Which tool was used
  input       Json   // Input to the tool
  output      Json?  // Output from the tool
  reasoning   String? @db.Text // Agent's reasoning for this step

  status      String // "running", "completed", "failed"
  error       String? @db.Text

  tokens      Int    @default(0)
  credits     Int    @default(0)
  duration    Int    @default(0) // Milliseconds

  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([taskId, step])
  @@index([taskId, createdAt])
}

// Agent health and metrics tracking
model AgentMetrics {
  id String @id @default(cuid())

  agentType      String // "browser_automation", "email_campaign", etc.
  tasksCompleted Int    @default(0)
  tasksFailed    Int    @default(0)
  totalTokens    Int    @default(0)
  totalCredits   Int    @default(0)
  avgDuration    Int    @default(0) // Average milliseconds
  successRate    Float  @default(0) // 0-100

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentType, date])
  @@index([agentType])
  @@index([date])
}

// ============================================
// AI BROWSER SERVICE MODELS
// ============================================

// BrowserSession - Persistent browser sessions with chat/navigation capabilities
model BrowserSession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session configuration
  url         String  @db.Text // Current URL
  title       String? // Current page title
  userAgent   String? // Browser user agent
  viewport    Json?   // { width, height }
  cookies     Json?   // Saved cookies for session persistence
  localStorage Json?  // Saved localStorage state

  // Feature flags
  chatEnabled       Boolean @default(false)
  navigationEnabled Boolean @default(false)
  recordingWorkflow Boolean @default(false)

  // Status
  status     String   @default("active") // active, paused, closed, synced
  startedAt  DateTime @default(now())
  closedAt   DateTime?
  lastSyncAt DateTime? // Last cookie sync from browser extension

  // Resource tracking
  totalCreditsUsed Int @default(0)
  totalTokensUsed  Int @default(0)

  // Relations
  webpageContexts WebpageContext[]
  chatMessages    ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([userId, createdAt])
}

// WebpageContext - Cached page content for chat functionality
model WebpageContext {
  id               String         @id @default(cuid())
  browserSessionId String
  browserSession   BrowserSession @relation(fields: [browserSessionId], references: [id], onDelete: Cascade)

  url          String   @db.Text
  title        String?
  extractedAt  DateTime @default(now())

  // Content extraction
  mainContent    String? @db.Text // Main article/content from Readability.js
  structuredData Json?            // Extracted structured data (headings, lists, tables)
  metadata       Json?            // Meta tags, Open Graph data
  links          Json?            // All links on page
  images         Json?            // All images on page

  // AI optimization
  contentSummary String? @db.Text // AI-generated summary for context window efficiency
  embeddings     Json?            // Vector embeddings for semantic search (future)

  // Cache management
  expiresAt DateTime? // When to refresh this context
  isStale   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([browserSessionId])
  @@index([url])
}

// ChatMessage - Chat messages between user and AI about webpage
model ChatMessage {
  id               String         @id @default(cuid())
  browserSessionId String
  browserSession   BrowserSession @relation(fields: [browserSessionId], references: [id], onDelete: Cascade)

  role    String // "user" | "assistant" | "system"
  content String @db.Text

  // AI metadata
  model           String? // AI model used for assistant response
  tokens          Int?    // Token count for this message
  credits         Int?    // Credits consumed
  thinkingEnabled Boolean @default(false)

  // Context reference
  contextUrl String? @db.Text // Which page this message refers to

  createdAt DateTime @default(now())

  @@index([browserSessionId, createdAt])
}

// Workflow - User-defined automation workflows
model Workflow {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text
  icon        String? // Icon identifier
  color       String? // Hex color

  // Workflow configuration
  steps          WorkflowStep[]
  schedule       String? // Cron expression for scheduled runs
  isAIAssisted   Boolean @default(true) // Use AI for error recovery
  timeoutSeconds Int     @default(300) // 5 minutes default

  // Status
  isActive   Boolean @default(true)
  isTemplate Boolean @default(false) // Public template workflow

  // Analytics
  totalRuns      Int @default(0)
  successfulRuns Int @default(0)
  failedRuns     Int @default(0)
  lastRunAt      DateTime?

  // Relations
  executions WorkflowExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
  @@index([userId, createdAt])
  @@index([isTemplate])
}

// WorkflowStep - Individual actions in a workflow
model WorkflowStep {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  order Int // Step order in workflow

  // Step configuration
  type   String // "navigate", "click", "type", "extract", "wait", "conditional", "loop"
  action Json   // Action-specific parameters

  // Error handling
  onError      String @default("stop") // "stop", "continue", "retry", "ai_recovery"
  maxRetries   Int    @default(3)
  retryDelay   Int    @default(1000) // Milliseconds

  // Conditional logic
  condition   Json?   // Condition to evaluate before executing
  skipIfFalse Boolean @default(false)

  // Output
  saveOutput   Boolean @default(false)
  outputName   String? // Variable name to save output

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workflowId, order])
}

// WorkflowExecution - Execution history for workflows
model WorkflowExecution {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Execution metadata
  status      String   @default("running") // running, completed, failed, cancelled
  startedAt   DateTime @default(now())
  completedAt DateTime?

  // Results
  currentStep    Int    @default(0)
  totalSteps     Int
  result         Json?  // Final output/result
  error          String? @db.Text
  executionTrace Json?  // Detailed trace of all steps

  // AI interventions
  aiRecoveries     Int @default(0) // Number of times AI recovered from errors
  aiRecoveryDetail Json? // Details of AI interventions

  // Resource usage
  totalTokens  Int @default(0)
  totalCredits Int @default(0)
  duration     Int @default(0) // Milliseconds

  createdAt DateTime @default(now())

  @@index([workflowId, createdAt])
  @@index([status])
}

// PageMonitor - Configuration for page monitoring
model PageMonitor {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text
  url         String  @db.Text

  // Check configuration
  checkType     String @default("text") // "text", "element", "screenshot", "ai"
  checkInterval Int    @default(3600) // Seconds between checks (default: 1 hour)
  selector      String? // CSS selector to monitor
  aiPrompt      String? @db.Text // AI prompt for intelligent monitoring

  // Alert rules
  alertOnChange Boolean @default(true)
  alertChannels Json    @default("[]") // ["email", "slack", "webhook"]
  webhookUrl    String? @db.Text

  // Status
  isActive      Boolean   @default(true)
  lastCheckedAt DateTime?
  lastValue     String?   @db.Text // Last observed value
  lastHash      String? // Hash of content for change detection

  // Analytics
  totalChecks   Int @default(0)
  alertsTriggered Int @default(0)

  // Relations
  alerts MonitorAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
  @@index([userId, lastCheckedAt])
  @@index([isActive, checkInterval]) // For background job querying
}

// MonitorAlert - Triggered alerts from monitoring
model MonitorAlert {
  id        String      @id @default(cuid())
  monitorId String
  monitor   PageMonitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  // Alert details
  triggeredAt DateTime @default(now())
  changeType  String   @default("content_changed") // content_changed, element_appeared, element_disappeared, ai_detected

  oldValue    String? @db.Text
  newValue    String? @db.Text

  // AI analysis
  aiAnalysis  String? @db.Text // AI-generated explanation of the change

  // Delivery status
  delivered Boolean @default(false)
  deliveredAt DateTime?
  deliveryChannels Json? // Which channels were notified

  // Screenshot comparison (future feature)
  oldScreenshot String? @db.Text // Base64 or URL
  newScreenshot String? @db.Text

  createdAt DateTime @default(now())

  @@index([monitorId, triggeredAt])
  @@index([delivered])
}

// Integration - Third-party service integrations
model Integration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Integration identity
  provider String // "notion", "slack", "zapier", "custom"
  name     String // User-friendly name

  // OAuth/API credentials
  accessToken  String? @db.Text
  refreshToken String? @db.Text
  tokenExpiry  DateTime?
  apiKey       String? @db.Text // For API key-based integrations
  webhookUrl   String? @db.Text

  // Configuration
  config Json? // Provider-specific configuration
  scopes String[] // Granted scopes/permissions

  // Status
  isActive      Boolean @default(true)
  lastUsedAt    DateTime?
  lastSyncAt    DateTime?

  // Relations
  customTools CustomTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId, isActive])
}

// CustomTool - User-defined tools for workflow automation
model CustomTool {
  id            String      @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // Tool definition
  name        String
  description String? @db.Text
  endpoint    String  @db.Text // API endpoint to call
  method      String  @default("POST") // HTTP method

  // Parameters
  parameters     Json // Input parameter schema (JSON Schema)
  headers        Json? // Custom headers
  authentication Json? // Auth config (if not using integration tokens)

  // Response handling
  responseMapping Json? // How to map response to workflow output
  errorMapping    Json? // How to handle error responses

  // Usage tracking
  totalCalls Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([integrationId])
}

// ============================================
// MEMORY SYSTEM MODELS (OpenClaw-inspired)
// ============================================

// UserMemoryMeta - Per-user memory configuration
model UserMemoryMeta {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalFiles       Int      @default(0)
  totalChunks      Int      @default(0)
  lastIndexed      DateTime?
  embeddingModel   String   @default("text-embedding-3-small")
  embeddingDimensions Int   @default(1536)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// MemoryFile - Files stored in memory system
model MemoryFile {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  filePath      String
  source        String @default("memory") // memory, conversation, agent_log, daily_log
  chunkCount    Int    @default(0)
  lastIndexed   DateTime @default(now())
  fileHash      String? // For detecting changes
  contentPreview String? @db.Text // First 500 chars

  // Relations
  chunks MemoryChunk[]

  // Metadata
  metadata Json? // Additional file metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, filePath])
  @@index([userId, source])
  @@index([userId, lastIndexed])
}

// MemoryChunk - Text chunks with embeddings
model MemoryChunk {
  id     String @id @default(cuid())
  fileId String
  file   MemoryFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  chunkId    String // {filePath}:{startLine}-{endLine}
  text       String @db.Text
  startLine  Int
  endLine    Int
  tokenCount Int    @default(0)

  // Vector embedding (stored as JSON array for Prisma compatibility)
  // Will be converted to pgvector type via raw SQL
  embedding Json? // [0.1, 0.2, ...] array of 1536 floats

  // Search optimization
  searchVector String? @db.Text // Full-text search (tsvector equivalent)

  // Access tracking
  accessCount  Int      @default(0)
  lastAccessed DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chunkId])
  @@index([fileId])
}

// EmbeddingCache - Cache embeddings to save API costs
model EmbeddingCache {
  id String @id @default(cuid())

  contentHash String  @unique // SHA-256 hash of content
  content     String  @db.Text
  model       String // Embedding model used
  embedding   Json // Embedding vector as JSON array

  // Cache management
  hitCount     Int      @default(0)
  lastAccessed DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([model, contentHash])
  @@index([lastAccessed]) // For LRU eviction
}

// MemorySearchLog - Track search queries for analytics
model MemorySearchLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  query        String @db.Text
  resultCount  Int    @default(0)
  vectorScore  Float?
  textScore    Float?
  finalScore   Float?
  latency      Int    @default(0) // Milliseconds

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// ============================================
// PHASE 2: AUTO-INDEXING & CONSOLIDATION
// ============================================

// UserIndexingConfig - Per-user auto-indexing configuration
model UserIndexingConfig {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  autoIndexEnabled             Boolean  @default(true)
  minMessagesToIndex           Int      @default(5)
  indexOnSessionEnd            Boolean  @default(true)
  consolidateOnIndex           Boolean  @default(true)
  consolidationIntervalHours   Int      @default(6)
  lastConsolidationAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// IndexedSession - Track indexed conversation sessions
model IndexedSession {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sessionId           String
  fileId              String? // Reference to MemoryFile
  messageCount        Int     @default(0)
  consolidationStatus String  @default("pending") // pending, processing, completed, failed
  factsExtracted      Int     @default(0)
  indexedAt           DateTime @default(now())
  consolidatedAt      DateTime?
  error               String?  @db.Text

  metadata Json? // Session metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sessionId])
  @@index([userId, consolidationStatus])
  @@index([consolidationStatus, indexedAt])
}

// MemoryFact - Extracted facts from conversations
model MemoryFact {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  factType       String // preference, fact, decision, context, goal, skill
  content        String @db.Text
  sourceFileId   String? // Reference to MemoryFile
  sourceChunkIds String[] // Array of chunk IDs

  // Vector embedding as JSON
  embedding Json?

  // Scoring
  confidenceScore Float @default(0.8)
  importanceScore Float @default(0.5)

  // Lifecycle
  lastAccessed DateTime @default(now())
  accessCount  Int      @default(0)
  expiresAt    DateTime? // Optional expiration

  metadata Json? // Additional fact metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, factType])
  @@index([userId, importanceScore])
  @@index([expiresAt])
}

// ConsolidationJob - Track consolidation job execution
model ConsolidationJob {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobType String @default("scheduled") // scheduled, manual, triggered
  status  String @default("pending") // pending, running, completed, failed

  // Progress
  factsExtracted   Int @default(0)
  factsStored      Int @default(0)
  factsMerged      Int @default(0)
  chunksProcessed  Int @default(0)
  totalChunks      Int @default(0)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?      @default(0) // Milliseconds

  // Error handling
  error String? @db.Text

  metadata Json? // Job metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([status, createdAt])
}

// MessageImportance - Cache message importance scores
model MessageImportance {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  chunkId          String
  importanceScore  Float
  recencyFactor    Float
  accessFactor     Float
  calculatedAt     DateTime @default(now())

  @@unique([userId, chunkId])
  @@index([userId, importanceScore])
}

// ============================================
// SKILL MARKETPLACE MODELS
// ============================================

// CustomSkill - User-created or marketplace skills
model CustomSkill {
  id        String @id @default(cuid())
  creatorId String

  // Skill identity
  name        String
  description String @db.Text
  category    String // productivity, data, communication, integration, entertainment
  icon        String? // Icon identifier or emoji

  // Pricing
  pricingModel String @default("free") // free, one-time, subscription
  price        Int    @default(0) // USD cents

  // Technical specs
  requiredTools        String[] // Tools this skill needs
  requiredIntegrations String[] // Integrations required (slack, github, etc)
  estimatedCreditCost  Int      @default(0) // Credits per execution

  // Code/configuration
  skillType       String @default("config") // config, javascript, python
  skillDefinition Json // Either config JSON or code string
  parameters      Json   @default("[]") // Parameter schema for skill execution

  // Quality metrics
  downloads   Int   @default(0)
  rating      Float @default(0) // 1-5 stars
  reviewCount Int   @default(0)

  // Versioning
  version   String   @default("1.0.0")
  changelog Json     @default("[]") // Array of version changes

  // Marketplace status
  status   String  @default("draft") // draft, pending_review, approved, rejected, archived
  featured Boolean @default(false)

  // Review feedback (if rejected)
  reviewFeedback String? @db.Text
  reviewedAt     DateTime?
  reviewedBy     String? // Admin user ID

  // Relations
  installations SkillInstallation[]
  reviews       SkillReview[]

  // Analytics
  totalRevenue    Int @default(0) // USD cents
  monthlyRevenue  Int @default(0) // USD cents
  totalExecutions Int @default(0)
  lastUsedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId, status])
  @@index([status, featured])
  @@index([category, status])
  @@index([pricingModel, status])
}

// SkillInstallation - Track user installations of skills
model SkillInstallation {
  id      String      @id @default(cuid())
  userId  String
  skillId String
  skill   CustomSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  // Purchase info
  purchaseType String  @default("free") // free, one-time, subscription
  amountPaid   Int     @default(0) // USD cents
  transactionId String? // Stripe payment intent ID

  // Subscription info (if applicable)
  subscriptionId       String? // Stripe subscription ID
  subscriptionStatus   String? // active, cancelled, expired
  subscriptionPeriodEnd DateTime?

  // Usage tracking
  executionCount Int       @default(0)
  lastUsedAt     DateTime?

  // Installation status
  isActive   Boolean @default(true)
  installedAt DateTime @default(now())
  removedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillId])
  @@index([userId, isActive])
  @@index([skillId, installedAt])
}

// SkillReview - User reviews for skills
model SkillReview {
  id      String      @id @default(cuid())
  userId  String
  skillId String
  skill   CustomSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  rating  Float  // 1-5 stars
  title   String?
  comment String? @db.Text

  // Creator response
  response    String? @db.Text
  respondedAt DateTime?

  // Helpful votes
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  // Verification
  isVerified Boolean @default(false) // User actually installed/used the skill

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillId])
  @@index([skillId, rating])
  @@index([skillId, createdAt])
}

// ============================================
// VERTICAL TEMPLATES MODELS
// ============================================

// IndustryTemplate - Pre-configured agent templates for industries
model IndustryTemplate {
  id String @id @default(cuid())

  // Template identity
  name        String
  description String @db.Text
  industry    String // ecommerce, content-creation, real-estate, recruiting, finance, etc
  icon        String? // Icon identifier or emoji
  color       String? // Hex color

  // Agent configuration
  agentType      String  @default("custom") // Which agent type to use
  systemPrompt   String  @db.Text // Pre-configured system prompt
  suggestedModel String  @default("claude-sonnet-4-5-20250929") // Recommended model

  // Required capabilities
  requiredTools        String[] // Tools needed (browser, email, etc)
  optionalTools        String[] // Optional tools for enhanced features
  requiredIntegrations String[] // Integrations needed (slack, gmail, etc)

  // Sample workflows
  sampleWorkflows Json @default("[]") // Array of workflow definitions

  // Custom instructions template
  customInstructionsTemplate String? @db.Text // Template for user customization

  // Success metrics
  suggestedKPIs String[] // KPIs to track for this template

  // Template configuration
  defaultConfig Json @default("{}") // Default agent config

  // Marketplace
  tier       String  @default("free") // free, core, ultra - which tier can access
  featured   Boolean @default(false)
  order      Int     @default(0) // Display order

  // Analytics
  installCount Int       @default(0)
  lastUsedAt   DateTime?

  // Relations
  userSettings TemplateSetting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([industry, tier])
  @@index([featured, order])
  @@index([tier])
}

// TemplateSetting - User customizations of templates
model TemplateSetting {
  id         String           @id @default(cuid())
  userId     String
  templateId String
  template   IndustryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // User customization
  customName         String?
  customSystemPrompt String? @db.Text
  customConfig       Json? // Overrides for default config

  // Usage tracking
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, templateId])
  @@index([userId, isActive])
}

// ============================================
// MULTI-AGENT TEAMS MODELS
// ============================================

// AgentTeam - Groups of agents working together
model AgentTeam {
  id     String @id @default(cuid())
  userId String

  // Team identity
  name        String
  description String? @db.Text
  icon        String? // Icon identifier or emoji
  color       String? // Hex color

  // Team configuration
  teamType     String @default("sequential") // sequential, parallel, hierarchical
  maxAgents    Int    @default(5) // Max agents in team
  sharedMemory Boolean @default(true) // Share context between agents

  // Orchestration settings
  coordinationStrategy String @default("leader") // leader, democratic, autonomous
  errorHandling        String @default("rollback") // rollback, continue, ask

  // Relations
  agents         TeamAgent[]
  collaborations AgentCollaboration[]

  // Analytics
  totalTasks     Int       @default(0)
  successfulTasks Int      @default(0)
  failedTasks    Int       @default(0)
  lastUsedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, teamType])
}

// TeamAgent - Individual agent within a team
model TeamAgent {
  id     String    @id @default(cuid())
  teamId String
  team   AgentTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Agent identity
  name        String
  role        String // researcher, writer, analyst, communicator, coder
  description String? @db.Text

  // Agent configuration
  agentType      String // research, writer, data, communication, browser
  systemPrompt   String @db.Text
  model          String @default("claude-sonnet-4-5-20250929")
  tools          String[] // Available tools for this agent

  // Team position
  isLeader Boolean @default(false)
  order    Int     @default(0) // Execution order in sequential teams

  // Capabilities
  canDelegate    Boolean @default(false) // Can assign tasks to other agents
  canRequestHelp Boolean @default(true) // Can request help from other agents

  // Resource limits
  maxCreditsPerTask Int @default(1000)
  maxStepsPerTask   Int @default(20)
  timeoutSeconds    Int @default(300)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId, order])
  @@index([teamId, isLeader])
}

// AgentCollaboration - Track inter-agent communications and task handoffs
model AgentCollaboration {
  id     String    @id @default(cuid())
  teamId String
  team   AgentTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Task context
  taskId      String // Reference to parent Task
  parentTaskId String? // If this is a subtask

  // Agent communication
  fromAgentId String // Sending agent
  toAgentId   String // Receiving agent

  // Communication details
  type        String // delegation, request_help, share_context, report_result
  message     String @db.Text
  context     Json? // Shared context data

  // Status
  status      String   @default("pending") // pending, in_progress, completed, failed
  response    String?  @db.Text
  result      Json?

  // Timing
  sentAt      DateTime @default(now())
  respondedAt DateTime?

  createdAt DateTime @default(now())

  @@index([teamId, taskId])
  @@index([taskId, status])
  @@index([fromAgentId, toAgentId])
}
