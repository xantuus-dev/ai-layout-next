// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // Subscription & Billing
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // RevenueCat Integration
  revenueCatUserId     String? @unique
  revenueCatCustomerId String? // Original transaction app user ID

  // Plan & Limits
  plan           String   @default("free") // free, pro, enterprise
  monthlyCredits Int      @default(1000)
  creditsUsed    Int      @default(0)
  creditsResetAt DateTime @default(now())
  billingCycle   String? // monthly, yearly

  // Payment Status
  paymentFailed   Boolean   @default(false)
  paymentFailedAt DateTime?

  // Google Integrations
  googleAccessToken     String?   @db.Text
  googleRefreshToken    String?   @db.Text
  googleTokenExpiry     DateTime?
  googleDriveEnabled    Boolean   @default(false)
  googleGmailEnabled    Boolean   @default(false)
  googleCalendarEnabled Boolean   @default(false)

  // Usage tracking
  usageRecords UsageRecord[]
  apiKeys      ApiKey[]

  // Workspace features
  workspaces    Workspace[]
  conversations Conversation[]
  projects      Project[]
  tasks         Task[]

  // Referral system
  referralCode     String?    @unique // User's own referral code
  referredBy       String? // Referral code of user who referred them
  referredUsers    Referral[] @relation("Referrer")
  referralReceived Referral?  @relation("Referred")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Subscription & Usage Models
model UsageRecord {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    String // "chat", "api", "automation", etc.
  model   String? // AI model used
  tokens  Int     @default(0)
  credits Int     @default(1) // Credits consumed

  metadata Json? // Additional data

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  key      String    @unique
  lastUsed DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Webhook Event Tracking (for idempotency)
model WebhookEvent {
  id        String  @id @default(cuid())
  provider  String // 'stripe' or 'revenuecat'
  eventId   String  @unique // The event ID from the provider
  eventType String // Event type (e.g., 'customer.subscription.updated')
  processed Boolean @default(true)
  payload   Json? // Optional: store the full payload for debugging

  createdAt DateTime @default(now())

  @@index([provider, eventId])
  @@index([createdAt])
}

// Prompt Template System
model PromptTemplateCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String? // Icon name or emoji
  order       Int     @default(0)

  templates PromptTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromptTemplate {
  id String @id @default(cuid())

  // Template Info
  title       String
  description String?
  template    String  @db.Text // The prompt with {{variable}} placeholders

  // Organization
  categoryId String?
  category   PromptTemplateCategory? @relation(fields: [categoryId], references: [id])
  tags       String[] // For additional filtering

  // Variables Configuration
  // JSON structure: [{ name: "variable_name", label: "Display Label", type: "text|number|select", placeholder: "...", options: [] }]
  variables Json @default("[]")

  // Visibility & Status
  isPublic   Boolean @default(true)
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Analytics
  usageCount Int @default(0)

  // Premium/Tier System
  tier String @default("free") // 'free', 'pro', 'enterprise'

  // Integration Requirements
  requiresGoogleDrive Boolean @default(false)
  requiresGmail       Boolean @default(false)
  requiresCalendar    Boolean @default(false)
  supportsImageGen    Boolean @default(false)

  // Admin tracking
  createdBy String? // Admin user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isPublic, isActive])
  @@index([tier, isActive])
}

// Workspace Models
model Project {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  name        String
  description String? @db.Text
  color       String? // Hex color for project identification
  icon        String? // Icon identifier

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt])
  @@index([workspaceId])
}

model Task {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  title       String
  description String? @db.Text
  status      String  @default("pending") // pending, planning, executing, paused, completed, failed, cancelled
  priority    String  @default("medium") // low, medium, high, urgent

  // Agent/AI Configuration
  agentType   String? // "browser_automation", "email_campaign", "data_processing", "research"
  agentModel  String? // Which AI model/agent to use for this task
  agentConfig Json? // Agent-specific configuration

  // Execution plan
  plan         Json?   // Execution plan from planner
  planTokens   Int     @default(0) // Tokens used for planning
  planCredits  Int     @default(0) // Credits used for planning

  // Execution tracking
  currentStep    Int       @default(0) // Which step is currently executing
  totalSteps     Int       @default(0) // Total steps in plan
  attempts       Int       @default(0)
  lastRunAt      DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  failedAt       DateTime?

  // Results and state
  result         Json?     // Final result
  executionTrace Json?     // Full trace of what agent did
  error          String?   @db.Text // Error message if failed

  // Resource usage
  totalTokens    Int       @default(0)
  totalCredits   Int       @default(0)
  executionTime  Int       @default(0) // Milliseconds

  // Task metadata
  dueDate     DateTime?
  tags        String[]

  // Relations
  executions  TaskExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, priority]) // For queue polling
}

// Referral System
model Referral {
  id String @id @default(cuid())

  referrerId String
  referrer   User   @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  referredId String @unique
  referred   User   @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  creditsAwarded Int    @default(500) // Credits given to both parties
  status         String @default("pending") // pending, completed

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([referrerId])
  @@index([referredId])
}

// Workspace System Models

// Workspace - Groups projects and conversations per user
model Workspace {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text
  icon        String? // Icon identifier or emoji
  color       String? // Hex color for workspace identification
  isDefault   Boolean @default(false) // One default workspace per user

  // Relations
  projects      Project[]
  conversations Conversation[]
  members       WorkspaceMember[]

  // Organization
  order Int @default(0) // For custom ordering in sidebar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
  @@index([userId, order])
}

// Conversation - Persistent chat threads
model Conversation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  title   String  @default("Untitled Conversation") // Auto-generated from first message or user-defined
  summary String? @db.Text // AI-generated summary of conversation

  // Organization
  isPinned   Boolean  @default(false)
  isFavorite Boolean  @default(false)
  isArchived Boolean  @default(false)
  tags       String[] // User-defined tags for organization
  folder     String? // Folder path for hierarchical organization

  // Metadata
  model         String? // Primary AI model used
  messageCount  Int      @default(0)
  lastMessageAt DateTime @default(now())

  // Relations
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([userId, lastMessageAt])
  @@index([userId, isArchived])
  @@index([userId, folder])
}

// Message - Individual chat messages
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // "user" | "assistant" | "system"
  content String @db.Text

  // AI metadata
  model           String? // AI model used for this response
  tokens          Int? // Token count for this message
  credits         Int? // Credits consumed for this message
  thinkingEnabled Boolean @default(false)

  // Attachments
  attachments MessageAttachment[]

  // Message metadata
  isEdited        Boolean   @default(false)
  editedAt        DateTime?
  parentMessageId String? // For future threading support

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId, createdAt])
  @@index([conversationId])
}

// MessageAttachment - File uploads with messages
model MessageAttachment {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  fileName String
  fileType String // MIME type
  fileSize Int // In bytes
  fileUrl  String? @db.Text // S3/storage URL if applicable
  fileData String? @db.Text // Base64 encoded data for small files

  // Image-specific metadata
  width     Int?
  height    Int?
  thumbnail String? @db.Text // Thumbnail for images

  createdAt DateTime @default(now())

  @@index([messageId])
}

// WorkspaceMember - For future collaboration features
model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId      String // Member user ID
  role        String @default("member") // "owner" | "admin" | "member" | "viewer"
  permissions Json? // Granular permissions

  invitedBy String? // User ID who sent invite
  invitedAt DateTime  @default(now())
  joinedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

// Agent Execution System
// Detailed execution log for each step of an agent's execution
model TaskExecution {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  step        Int    // Which step this execution represents
  action      String // What action was taken (e.g., "browser.navigate")
  tool        String? // Which tool was used
  input       Json   // Input to the tool
  output      Json?  // Output from the tool
  reasoning   String? @db.Text // Agent's reasoning for this step

  status      String // "running", "completed", "failed"
  error       String? @db.Text

  tokens      Int    @default(0)
  credits     Int    @default(0)
  duration    Int    @default(0) // Milliseconds

  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([taskId, step])
  @@index([taskId, createdAt])
}

// Agent health and metrics tracking
model AgentMetrics {
  id String @id @default(cuid())

  agentType      String // "browser_automation", "email_campaign", etc.
  tasksCompleted Int    @default(0)
  tasksFailed    Int    @default(0)
  totalTokens    Int    @default(0)
  totalCredits   Int    @default(0)
  avgDuration    Int    @default(0) // Average milliseconds
  successRate    Float  @default(0) // 0-100

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentType, date])
  @@index([agentType])
  @@index([date])
}
